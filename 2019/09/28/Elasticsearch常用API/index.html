<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="哲锄">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="https://zhechu.github.io">
    <!--SEO-->

    <meta name="keywords" content="搜索,">


    <meta name="description" content="环境说明



环境
说明




Elasticsearch-7.1.1
分布式、RESTful 风格的搜索和数据分析引擎



官方文档
https://www.elastic.co/guide/en/elasticsearch/reference/7.1/index.html

TIPS...">


<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">
    <!--Title-->


<title>Elasticsearch常用API | 哲锄</title>


    <link rel="alternate" href="/atom.xml" title="哲锄" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    





    

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="https://zhechu.github.io">哲锄</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa fa-home"></i>哲锄</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories"><i class="fa fa-list"></i>分类</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/about"><i class="fa fa-user"></i>关于我</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/archives"><i class="fa fa-archive"></i>归档</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>

<a href="http://github.com/zhechu">
    <img style="position: absolute; top: 0; right: 0; border: 0;"
        src="/img/forkme.png"
        alt="Fork me on GitHub">
</a>

    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="Elasticsearch常用API">
            
                Elasticsearch常用API
            
        </h1>
        <div class="post-meta">
    
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a href="/categories/ELK">
            ELK
        </a>
    </span>
    

    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
                
                    <a href="/tags/搜索" title='搜索'>
                        搜索
                    </a>
                
            
        </span>
    </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2019/09/28</span>
        </span>
        
            <span class="fa-wrap">
                <i class="fa fa-eye"></i>
                <span id="busuanzi_value_page_pv"></span>
            </span>
        
    
</div>

        
        
    </div>
    
    <div class="post-body post-content">
        <p>环境说明</p>
<table>
<thead>
<tr>
<th>环境</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Elasticsearch-7.1.1</td>
<td>分布式、RESTful 风格的搜索和数据分析引擎</td>
</tr>
</tbody>
</table>
<p>官方文档</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/index.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/index.html</a></p>
<blockquote>
<p>TIPS：可以借助 Kibana 的 Dev Tools 工具学习 API 的使用。</p>
</blockquote>
<h2 id="1-cat-APIs"><a href="#1-cat-APIs" class="headerlink" title="1 cat APIs"></a>1 cat APIs</h2><p>列出所有可用的命令<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">=^.^=</span><br><span class="line">/_cat/allocation</span><br><span class="line">/_cat/shards</span><br><span class="line">/_cat/shards/&#123;index&#125;</span><br><span class="line">/_cat/master</span><br><span class="line">/_cat/nodes</span><br><span class="line">/_cat/tasks</span><br><span class="line">/_cat/indices</span><br><span class="line">/_cat/indices/&#123;index&#125;</span><br><span class="line">/_cat/segments</span><br><span class="line">/_cat/segments/&#123;index&#125;</span><br><span class="line">/_cat/count</span><br><span class="line">/_cat/count/&#123;index&#125;</span><br><span class="line">/_cat/recovery</span><br><span class="line">/_cat/recovery/&#123;index&#125;</span><br><span class="line">/_cat/health</span><br><span class="line">/_cat/pending_tasks</span><br><span class="line">/_cat/aliases</span><br><span class="line">/_cat/aliases/&#123;alias&#125;</span><br><span class="line">/_cat/thread_pool</span><br><span class="line">/_cat/thread_pool/&#123;thread_pools&#125;</span><br><span class="line">/_cat/plugins</span><br><span class="line">/_cat/fielddata</span><br><span class="line">/_cat/fielddata/&#123;fields&#125;</span><br><span class="line">/_cat/nodeattrs</span><br><span class="line">/_cat/repositories</span><br><span class="line">/_cat/snapshots/&#123;repository&#125;</span><br><span class="line">/_cat/templates</span><br></pre></td></tr></table></figure>
<h3 id="1-1-通用参数"><a href="#1-1-通用参数" class="headerlink" title="1.1 通用参数"></a>1.1 通用参数</h3><h4 id="1-1-1-Verbose"><a href="#1-1-1-Verbose" class="headerlink" title="1.1.1 Verbose"></a>1.1.1 Verbose</h4><p>使用查询字符串 v 返回详细的输出<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/master&amp;v</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id                     host       ip         node</span><br><span class="line">UBgiq696RjueDK3QPFTrgQ 172.17.0.2 172.17.0.2 3c0f6c163958</span><br></pre></td></tr></table></figure>
<p>VS</p>
<p>未使用 v 参数时的效果<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/master</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UBgiq696RjueDK3QPFTrgQ 172.17.0.2 172.17.0.2 3c0f6c163958</span><br></pre></td></tr></table></figure>
<h4 id="1-1-2-Sort"><a href="#1-1-2-Sort" class="headerlink" title="1.1.2 Sort"></a>1.1.2 Sort</h4><p>按照文档个数排序<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/indices?v&amp;s=docs.count:desc</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">health status index                        uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">green  open   kibana_sample_data_logs      mrD7U27WQ5ugNY6RwBB-1Q   1   0      14005            0     10.9mb         10.9mb</span><br><span class="line">green  open   kibana_sample_data_flights   _sGYWo0aQXeaLI00jZeZEA   1   0      13059            0      6.2mb          6.2mb</span><br><span class="line">yellow open   movies                       TmWPFRCqTceXRNX8nA_yeA   1   1       9743            0      1.3mb          1.3mb</span><br><span class="line">green  open   kibana_sample_data_ecommerce gqPCrfMyRvmJ9n33e_z4HA   1   0       4675            0      5.1mb          5.1mb</span><br><span class="line">green  open   .kibana_1                    d4xaJEmhRpaPHHDe3RA2Qw   1   0        141            1        1mb            1mb</span><br><span class="line">green  open   .kibana_task_manager         -Z0bZeeeQaCNnL6Udrjh6w   1   0          2            0     54.8kb         54.8kb</span><br></pre></td></tr></table></figure>
<h2 id="2-Indices-APIs"><a href="#2-Indices-APIs" class="headerlink" title="2 Indices APIs"></a>2 Indices APIs</h2><p>查看 kibana_sample_data_ecommerce 索引的相关信息<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce</span><br></pre></td></tr></table></figure></p>
<h2 id="3-Search-APIs"><a href="#3-Search-APIs" class="headerlink" title="3 Search APIs"></a>3 Search APIs</h2><p>查看 kibana_sample_data_ecommerce 索引的文档总数<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_count</span><br></pre></td></tr></table></figure></p>
<p>查看 kibana_sample_data_ecommerce 索引的前10条文档<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>基本查询<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /movies/_search?q=2012&amp;df=title&amp;sort=year:desc&amp;from=0&amp;size=10&amp;timeout=1s</span><br></pre></td></tr></table></figure></p>
<p>带profile<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /movies/_search?q=2012&amp;df=title</span><br><span class="line">&#123;</span><br><span class="line">	"profile":"true"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>泛查询，正对_all,所有字段<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /movies/_search?q=2012</span><br><span class="line">&#123;</span><br><span class="line">	"profile":"true"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>指定字段<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /movies/_search?q=title:2012&amp;sort=year:desc&amp;from=0&amp;size=10&amp;timeout=1s</span><br><span class="line">&#123;</span><br><span class="line">	"profile":"true"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查找美丽心灵, Mind为泛查询<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /movies/_search?q=title:Beautiful Mind</span><br><span class="line">&#123;</span><br><span class="line">	"profile":"true"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>泛查询<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /movies/_search?q=title:2012</span><br><span class="line">&#123;</span><br><span class="line">	"profile":"true"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用引号，Phrase查询<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /movies/_search?q=title:"Beautiful Mind"</span><br><span class="line">&#123;</span><br><span class="line">	"profile":"true"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>分组，Bool查询<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /movies/_search?q=title:(Beautiful Mind)</span><br><span class="line">&#123;</span><br><span class="line">	"profile":"true"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查找美丽心灵，布尔操作符<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /movies/_search?q=title:(Beautiful AND Mind)</span><br><span class="line">&#123;</span><br><span class="line">	"profile":"true"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查找美丽心灵<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /movies/_search?q=title:(Beautiful NOT Mind)</span><br><span class="line">&#123;</span><br><span class="line">	"profile":"true"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查找美丽心灵<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /movies/_search?q=title:(Beautiful %2BMind)</span><br><span class="line">&#123;</span><br><span class="line">	"profile":"true"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>范围查询 ,区间写法<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /movies/_search?q=title:beautiful AND year:[2002 TO 2018%7D</span><br><span class="line">&#123;</span><br><span class="line">	"profile":"true"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通配符查询<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /movies/_search?q=title:b*</span><br><span class="line">&#123;</span><br><span class="line">	"profile":"true"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>模糊匹配&amp;近似度匹配<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /movies/_search?q=title:beautifl~1</span><br><span class="line">&#123;</span><br><span class="line">	"profile":"true"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /movies/_search?q=title:"Lord Rings"~2</span><br><span class="line">&#123;</span><br><span class="line">	"profile":"true"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-Cluster-APIs"><a href="#4-Cluster-APIs" class="headerlink" title="4 Cluster APIs"></a>4 Cluster APIs</h2><p>查看集群健康情况<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET _cluster/health</span><br></pre></td></tr></table></figure></p>
<p>查看集群信息<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET _cluster/state</span><br></pre></td></tr></table></figure></p>
<h2 id="5-Document-APIs"><a href="#5-Document-APIs" class="headerlink" title="5 Document APIs"></a>5 Document APIs</h2><h3 id="5-1-创建文档"><a href="#5-1-创建文档" class="headerlink" title="5.1 创建文档"></a>5.1 创建文档</h3><p>创建 users 索引的文档，自动生成 _id<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST users/_doc</span><br><span class="line">&#123;</span><br><span class="line">	"user" : "Mike",</span><br><span class="line">    "post_date" : "2019-04-15T14:12:12",</span><br><span class="line">    "message" : "trying out Kibana"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>创建 users 索引的文档，指定 _id，若 _id 已经存在，则报错<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT users/_doc/1?op_type=create</span><br><span class="line">&#123;</span><br><span class="line">    "user" : "Jack",</span><br><span class="line">    "post_date" : "2019-05-15T14:12:12",</span><br><span class="line">    "message" : "trying out Elasticsearch"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>或<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT users/_create/1</span><br><span class="line">&#123;</span><br><span class="line">     "user" : "Jack",</span><br><span class="line">    "post_date" : "2019-05-15T14:12:12",</span><br><span class="line">    "message" : "trying out Elasticsearch"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="5-2-删除文档"><a href="#5-2-删除文档" class="headerlink" title="5.2 删除文档"></a>5.2 删除文档</h3><p>删除文档<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE users/_doc/1</span><br></pre></td></tr></table></figure></p>
<h3 id="5-3-更新文档"><a href="#5-3-更新文档" class="headerlink" title="5.3 更新文档"></a>5.3 更新文档</h3><p>根据 _id 更新文档，先删除再写入<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT users/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">	"user" : "Mike"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在原文档上增加字段<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST users/_update/1/</span><br><span class="line">&#123;</span><br><span class="line">    "doc":&#123;</span><br><span class="line">        "post_date" : "2019-05-15T14:12:12",</span><br><span class="line">        "message" : "trying out Elasticsearch"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="5-4-查询文档"><a href="#5-4-查询文档" class="headerlink" title="5.4 查询文档"></a>5.4 查询文档</h3><p>根据 _id 查看文档<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET users/_doc/1</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "_index" : "users",</span><br><span class="line">  "_type" : "_doc",</span><br><span class="line">  "_id" : "1",</span><br><span class="line">  "_version" : 1,</span><br><span class="line">  "_seq_no" : 1,</span><br><span class="line">  "_primary_term" : 1,</span><br><span class="line">  "found" : true,</span><br><span class="line">  "_source" : &#123;</span><br><span class="line">    "user" : "Jack",</span><br><span class="line">    "post_date" : "2019-05-15T14:12:12",</span><br><span class="line">    "message" : "trying out Elasticsearch"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看 users 索引的文档<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST users/_search</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "took" : 1,</span><br><span class="line">  "timed_out" : false,</span><br><span class="line">  "_shards" : &#123;</span><br><span class="line">    "total" : 1,</span><br><span class="line">    "successful" : 1,</span><br><span class="line">    "skipped" : 0,</span><br><span class="line">    "failed" : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits" : &#123;</span><br><span class="line">    "total" : &#123;</span><br><span class="line">      "value" : 2,</span><br><span class="line">      "relation" : "eq"</span><br><span class="line">    &#125;,</span><br><span class="line">    "max_score" : 1.0,</span><br><span class="line">    "hits" : [</span><br><span class="line">      &#123;</span><br><span class="line">        "_index" : "users",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "6-yLd20BKZyFt5vLC64T",</span><br><span class="line">        "_score" : 1.0,</span><br><span class="line">        "_source" : &#123;</span><br><span class="line">          "user" : "Mike",</span><br><span class="line">          "post_date" : "2019-04-15T14:12:12",</span><br><span class="line">          "message" : "trying out Kibana"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index" : "users",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "1",</span><br><span class="line">        "_score" : 1.0,</span><br><span class="line">        "_source" : &#123;</span><br><span class="line">          "user" : "Jack",</span><br><span class="line">          "post_date" : "2019-05-15T14:12:12",</span><br><span class="line">          "message" : "trying out Elasticsearch"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-Analysis"><a href="#6-Analysis" class="headerlink" title="6 Analysis"></a>6 Analysis</h2><p>安装 analysis-icu 分词器，可以解析中文字符<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> elasticsearch-plugin install analysis-icu</span><br></pre></td></tr></table></figure></p>
<p>安装 analysis-ik 分词器，可以解析中文字符<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.1.1/elasticsearch-analysis-ik-7.1.1.zip</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>TIPS：分词器有 ik_max_word（会将文本做最细粒度的拆分；尽可能多的拆分出词语） 和 ik_smart（会做最粗粒度的拆分；已被分出的词语将不会再次被其它词语占有）。</p>
</blockquote>
<p>使用 ik_max_word 进行中文分词<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  "analyzer": "ik_max_word",</span><br><span class="line">  "text": "他说的确实在理”"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "tokens" : [</span><br><span class="line">    &#123;</span><br><span class="line">      "token" : "他",</span><br><span class="line">      "start_offset" : 0,</span><br><span class="line">      "end_offset" : 1,</span><br><span class="line">      "type" : "CN_CHAR",</span><br><span class="line">      "position" : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "token" : "说",</span><br><span class="line">      "start_offset" : 1,</span><br><span class="line">      "end_offset" : 2,</span><br><span class="line">      "type" : "CN_CHAR",</span><br><span class="line">      "position" : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "token" : "的确",</span><br><span class="line">      "start_offset" : 2,</span><br><span class="line">      "end_offset" : 4,</span><br><span class="line">      "type" : "CN_WORD",</span><br><span class="line">      "position" : 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "token" : "确实在",</span><br><span class="line">      "start_offset" : 3,</span><br><span class="line">      "end_offset" : 6,</span><br><span class="line">      "type" : "CN_WORD",</span><br><span class="line">      "position" : 3</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "token" : "确实",</span><br><span class="line">      "start_offset" : 3,</span><br><span class="line">      "end_offset" : 5,</span><br><span class="line">      "type" : "CN_WORD",</span><br><span class="line">      "position" : 4</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "token" : "实在",</span><br><span class="line">      "start_offset" : 4,</span><br><span class="line">      "end_offset" : 6,</span><br><span class="line">      "type" : "CN_WORD",</span><br><span class="line">      "position" : 5</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "token" : "在理",</span><br><span class="line">      "start_offset" : 5,</span><br><span class="line">      "end_offset" : 7,</span><br><span class="line">      "type" : "CN_WORD",</span><br><span class="line">      "position" : 6</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 ik_max_word 进行中文分词<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  "analyzer": "ik_smart",</span><br><span class="line">  "text": "他说的确实在理”"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "tokens" : [</span><br><span class="line">    &#123;</span><br><span class="line">      "token" : "他",</span><br><span class="line">      "start_offset" : 0,</span><br><span class="line">      "end_offset" : 1,</span><br><span class="line">      "type" : "CN_CHAR",</span><br><span class="line">      "position" : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "token" : "说",</span><br><span class="line">      "start_offset" : 1,</span><br><span class="line">      "end_offset" : 2,</span><br><span class="line">      "type" : "CN_CHAR",</span><br><span class="line">      "position" : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "token" : "的确",</span><br><span class="line">      "start_offset" : 2,</span><br><span class="line">      "end_offset" : 4,</span><br><span class="line">      "type" : "CN_WORD",</span><br><span class="line">      "position" : 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "token" : "实",</span><br><span class="line">      "start_offset" : 4,</span><br><span class="line">      "end_offset" : 5,</span><br><span class="line">      "type" : "CN_CHAR",</span><br><span class="line">      "position" : 3</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "token" : "在理",</span><br><span class="line">      "start_offset" : 5,</span><br><span class="line">      "end_offset" : 7,</span><br><span class="line">      "type" : "CN_WORD",</span><br><span class="line">      "position" : 4</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用空白字符分析器<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  "analyzer": "whitespace",</span><br><span class="line">  "text":     "The quick brown fox."</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用标准分析器和字符串过滤器<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  "tokenizer": "standard",</span><br><span class="line">  "filter":  [ "lowercase", "asciifolding" ],</span><br><span class="line">  "text":      "Is this déja vu?"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>自定义分析器<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  "settings": &#123;</span><br><span class="line">    "analysis": &#123;</span><br><span class="line">      "analyzer": &#123;</span><br><span class="line">        "std_folded": &#123;</span><br><span class="line">          "type": "custom",</span><br><span class="line">          "tokenizer": "standard",</span><br><span class="line">          "filter": [</span><br><span class="line">            "lowercase",</span><br><span class="line">            "asciifolding"</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  "mappings": &#123;</span><br><span class="line">    "properties": &#123;</span><br><span class="line">      "my_text": &#123;</span><br><span class="line">        "type": "text",</span><br><span class="line">        "analyzer": "std_folded"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对文本执行分析过程，并返回文本的标记明细<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  "analyzer": "std_folded",</span><br><span class="line">  "text":     "Is this déjà vu?"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  "field": "my_text",</span><br><span class="line">  "text":  "Is this déjà vu?"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-1-Analyzer"><a href="#6-1-Analyzer" class="headerlink" title="6.1 Analyzer"></a>6.1 Analyzer</h3><p>html 剥离<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  "tokenizer":"keyword",</span><br><span class="line">  "char_filter":["html_strip"],</span><br><span class="line">  "text": "&lt;b&gt;hello world&lt;/b&gt;"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>路径级别<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  "tokenizer":"path_hierarchy",</span><br><span class="line">  "text":"/user/ymruan/a/b/c/d/e"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用 char filter 进行替换<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  "tokenizer": "standard",</span><br><span class="line">  "char_filter": [</span><br><span class="line">      &#123;</span><br><span class="line">        "type" : "mapping",</span><br><span class="line">        "mappings" : [ "- =&gt; _"]</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">  "text": "123-456, I-test! test-990 650-555-1234"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>char filter 替换表情符号<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  "tokenizer": "standard",</span><br><span class="line">  "char_filter": [</span><br><span class="line">      &#123;</span><br><span class="line">        "type" : "mapping",</span><br><span class="line">        "mappings" : [ ":) =&gt; happy", ":( =&gt; sad"]</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    "text": ["I am felling :)", "Feeling :( today"]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>按空格分词并过滤停止词和复数转单数等处理<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  "tokenizer": "whitespace",</span><br><span class="line">  "filter": ["stop","snowball"],</span><br><span class="line">  "text": ["The gilrs in China are playing this game!"]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>先转小写<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  "tokenizer": "whitespace",</span><br><span class="line">  "filter": ["lowercase","stop","snowball"],</span><br><span class="line">  "text": ["The gilrs in China are playing this game!"]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>正则表达式<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  "tokenizer": "standard",</span><br><span class="line">  "char_filter": [</span><br><span class="line">      &#123;</span><br><span class="line">        "type" : "pattern_replace",</span><br><span class="line">        "pattern" : "http://(.*)",</span><br><span class="line">        "replacement" : "$1"</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    "text" : "http://www.elastic.co"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="7-Query-DSL"><a href="#7-Query-DSL" class="headerlink" title="7 Query DSL"></a>7 Query DSL</h2><p>ignore_unavailable=true，可以忽略尝试访问不存在的索引“404_idx”导致的报错<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /movies,404_idx/_search?ignore_unavailable=true</span><br><span class="line">&#123;</span><br><span class="line">  "profile": true,</span><br><span class="line">	"query": &#123;</span><br><span class="line">		"match_all": &#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查询 movies 分页<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  "from":10,</span><br><span class="line">  "size":1,</span><br><span class="line">  "query":&#123;</span><br><span class="line">    "match_all": &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对日期排序<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  "sort":[&#123;"order_date":"desc"&#125;],</span><br><span class="line">  "query":&#123;</span><br><span class="line">    "match_all": &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>source 过滤<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  "_source":["order_date"],</span><br><span class="line">  "query":&#123;</span><br><span class="line">    "match_all": &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>脚本字段（可以用于排序）<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  "script_fields": &#123;</span><br><span class="line">    "new_field": &#123;</span><br><span class="line">      "script": &#123;</span><br><span class="line">        "lang": "painless",</span><br><span class="line">        "source": "doc['order_date'].value+'hello'"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match_all": &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>或查询（匹配其中一个单词即可）<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match": &#123;</span><br><span class="line">      "title": "last christmas"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>并查询（匹配所有单词）<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match": &#123;</span><br><span class="line">      "title": &#123;</span><br><span class="line">        "query": "last christmas",</span><br><span class="line">        "operator": "and"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>短语查询，必须匹配<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match_phrase": &#123;</span><br><span class="line">      "title":&#123;</span><br><span class="line">        "query": "One Love"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>短语查询，中间可以插值<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match_phrase": &#123;</span><br><span class="line">      "title":&#123;</span><br><span class="line">        "query": "one love",</span><br><span class="line">        "slop": 1</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="7-1-Query-string-query"><a href="#7-1-Query-string-query" class="headerlink" title="7.1 Query string query"></a>7.1 Query string query</h3><p>添加文档<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT /users/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  "name":"Ruan Yiming",</span><br><span class="line">  "about":"java, golang, node, swift, elasticsearch"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /users/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  "name":"Li Yiming",</span><br><span class="line">  "about":"Hadoop"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>并查询<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST users/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "query_string": &#123;</span><br><span class="line">      "default_field": "name",</span><br><span class="line">      "query": "Ruan AND Yiming"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>或和并查询<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST users/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "query_string": &#123;</span><br><span class="line">      "fields":["name","about"],</span><br><span class="line">      "query": "(Ruan AND Yiming) OR (Java AND Elasticsearch)"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Simple Query 默认的 operator 是 Or<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST users/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "simple_query_string": &#123;</span><br><span class="line">      "query": "Ruan AND Yiming",</span><br><span class="line">      "fields": ["name"]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Simple Query 指定操作类型<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST users/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "simple_query_string": &#123;</span><br><span class="line">      "query": "Ruan Yiming",</span><br><span class="line">      "fields": ["name"],</span><br><span class="line">      "default_operator": "AND"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>单字段查询<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /movies/_search</span><br><span class="line">&#123;</span><br><span class="line">	"profile": true,</span><br><span class="line">	"query":&#123;</span><br><span class="line">		"query_string":&#123;</span><br><span class="line">			"default_field": "title",</span><br><span class="line">			"query": "Beafiful AND Mind"</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">`</span><br></pre></td></tr></table></figure></p>
<p>多字段查询<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /movies/_search</span><br><span class="line">&#123;</span><br><span class="line">	"profile": true,</span><br><span class="line">	"query":&#123;</span><br><span class="line">		"query_string":&#123;</span><br><span class="line">			"fields":[</span><br><span class="line">				"title",</span><br><span class="line">				"year"</span><br><span class="line">			],</span><br><span class="line">			"query": "2012"</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="8-Mapping"><a href="#8-Mapping" class="headerlink" title="8 Mapping"></a>8 Mapping</h2><p>Mapping 中的字段一旦设定后，禁止直接修改。因为倒排索引生成后不允许直接修改。需要重新建立新的索引，做 reindex 操作。</p>
<p>类似数据库中的表结构定义，主要作用</p>
<ol>
<li>定义字段名字</li>
<li>定义字段的类型</li>
<li>定义倒排索引相关的配置（是否被索引？采用的 Analyzer）</li>
<li>对新增字段的处理 true false strict</li>
</ol>
<p>在 object 下，支持做 dynamic 的属性的定义</p>
<h3 id="8-1-Dynamic-Mapping"><a href="#8-1-Dynamic-Mapping" class="headerlink" title="8.1 Dynamic Mapping"></a>8.1 Dynamic Mapping</h3><p>写入文档，查看 Mapping<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT mapping_test/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  "firstName":"Chan",</span><br><span class="line">  "lastName": "Jackie",</span><br><span class="line">  "loginDate":"2018-07-24T10:29:48.103Z"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查看 Mapping 文件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET mapping_test/_mapping</span><br></pre></td></tr></table></figure></p>
<p>Delete index<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE mapping_test</span><br></pre></td></tr></table></figure></p>
<p>dynamic mapping，推断字段的类型<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT mapping_test/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">    "uid" : "123",</span><br><span class="line">    "isVip" : false,</span><br><span class="line">    "isAdmin": "true",</span><br><span class="line">    "age":19,</span><br><span class="line">    "heigh":180</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查看 Dynamic<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET mapping_test/_mapping</span><br></pre></td></tr></table></figure></p>
<p>默认 Mapping 支持 dynamic，写入的文档中加入新的字段<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT dynamic_mapping_test/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  "newField":"someValue"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该字段可以被搜索，数据也在 _source 中出现<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST dynamic_mapping_test/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query":&#123;</span><br><span class="line">    "match":&#123;</span><br><span class="line">      "newField":"someValue"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>改为 dynamic false<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT dynamic_mapping_test/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  "dynamic": false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>新增 anotherField<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT dynamic_mapping_test/_doc/10</span><br><span class="line">&#123;</span><br><span class="line">  "anotherField":"someValue"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该字段不可以被搜索，因为 dynamic 已经被设置为 false<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST dynamic_mapping_test/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query":&#123;</span><br><span class="line">    "match":&#123;</span><br><span class="line">      "anotherField":"someValue"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>获取文档<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET dynamic_mapping_test/_doc/10</span><br></pre></td></tr></table></figure></p>
<p>修改为 strict<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT dynamic_mapping_test/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  "dynamic": "strict"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>写入数据出错，HTTP Code 400<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT dynamic_mapping_test/_doc/12</span><br><span class="line">&#123;</span><br><span class="line">  "lastField":"value"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>删除索引<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE dynamic_mapping_test</span><br></pre></td></tr></table></figure></p>
<h3 id="8-2-Mapping-定义"><a href="#8-2-Mapping-定义" class="headerlink" title="8.2 Mapping 定义"></a>8.2 Mapping 定义</h3><p>设置 index 为 false<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">DELETE users</span><br><span class="line">PUT users</span><br><span class="line">&#123;</span><br><span class="line">    "mappings" : &#123;</span><br><span class="line">      "properties" : &#123;</span><br><span class="line">        "firstName" : &#123;</span><br><span class="line">          "type" : "text"</span><br><span class="line">        &#125;,</span><br><span class="line">        "lastName" : &#123;</span><br><span class="line">          "type" : "text"</span><br><span class="line">        &#125;,</span><br><span class="line">        "mobile" : &#123;</span><br><span class="line">          "type" : "text",</span><br><span class="line">          "index": false</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>添加文档<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT users/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  "firstName":"Ruan",</span><br><span class="line">  "lastName": "Yiming",</span><br><span class="line">  "mobile": "12345678"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>根据手机号查询，报错，因为没有被索引<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /users/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match": &#123;</span><br><span class="line">      "mobile":"12345678"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>设定 Null_value<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">DELETE users</span><br><span class="line">PUT users</span><br><span class="line">&#123;</span><br><span class="line">    "mappings" : &#123;</span><br><span class="line">      "properties" : &#123;</span><br><span class="line">        "firstName" : &#123;</span><br><span class="line">          "type" : "text"</span><br><span class="line">        &#125;,</span><br><span class="line">        "lastName" : &#123;</span><br><span class="line">          "type" : "text"</span><br><span class="line">        &#125;,</span><br><span class="line">        "mobile" : &#123;</span><br><span class="line">          "type" : "keyword",</span><br><span class="line">          "null_value": "NULL"</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>添加文档<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT users/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  "firstName":"Ruan",</span><br><span class="line">  "lastName": "Yiming",</span><br><span class="line">  "mobile": null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT users/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  "firstName":"Ruan2",</span><br><span class="line">  "lastName": "Yiming2"</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>根据手机号查询<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET users/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match": &#123;</span><br><span class="line">      "mobile":"NULL"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="9-Index-Templates"><a href="#9-Index-Templates" class="headerlink" title="9 Index Templates"></a>9 Index Templates</h2><p>默认情况下，数字字符串被映射成 text 类型，日期字符串被映射成日期类型<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT ttemplate/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">	"someNumber":"1",</span><br><span class="line">	"someDate":"2019/01/01"</span><br><span class="line">&#125;</span><br><span class="line">GET ttemplate/_mapping</span><br></pre></td></tr></table></figure></p>
<p>创建 template_test<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT /_template/template_test</span><br><span class="line">&#123;</span><br><span class="line">    "index_patterns" : ["test*"],</span><br><span class="line">    "order" : 1,</span><br><span class="line">    "settings" : &#123;</span><br><span class="line">    	"number_of_shards": 1,</span><br><span class="line">        "number_of_replicas" : 2</span><br><span class="line">    &#125;,</span><br><span class="line">    "mappings" : &#123;</span><br><span class="line">    	"date_detection": false,</span><br><span class="line">    	"numeric_detection": true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查看 template 信息<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_template/temp*</span><br></pre></td></tr></table></figure></p>
<p>写入新的数据，index 以 test 开头<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT testtemplate/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">	"someNumber":"1",</span><br><span class="line">	"someDate":"2019/01/01"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查看 testtemplate 信息<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET testtemplate/_mapping</span><br><span class="line">GET testtemplate/_settings</span><br></pre></td></tr></table></figure></p>
<p>使用动态模板<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  "mappings": &#123;</span><br><span class="line">    "dynamic_templates": [</span><br><span class="line">            &#123;</span><br><span class="line">        "strings_as_boolean": &#123;</span><br><span class="line">          "match_mapping_type":   "string",</span><br><span class="line">          "match":"is*",</span><br><span class="line">          "mapping": &#123;</span><br><span class="line">            "type": "boolean"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "strings_as_keywords": &#123;</span><br><span class="line">          "match_mapping_type":   "string",</span><br><span class="line">          "mapping": &#123;</span><br><span class="line">            "type": "keyword"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查看 GET my_index/_mapping 信息<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_mapping</span><br></pre></td></tr></table></figure></p>
<p>使用动态模板，结合路径<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">DELETE my_index</span><br><span class="line"></span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  "mappings": &#123;</span><br><span class="line">    "dynamic_templates": [</span><br><span class="line">      &#123;</span><br><span class="line">        "full_name": &#123;</span><br><span class="line">          "path_match":   "name.*",</span><br><span class="line">          "path_unmatch": "*.middle",</span><br><span class="line">          "mapping": &#123;</span><br><span class="line">            "type":       "text",</span><br><span class="line">            "copy_to":    "full_name"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  "name": &#123;</span><br><span class="line">    "first":  "John",</span><br><span class="line">    "middle": "Winston",</span><br><span class="line">    "last":   "Lennon"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET my_index/_search?q=full_name:John</span><br></pre></td></tr></table></figure></p>
<h2 id="10-Aggregations"><a href="#10-Aggregations" class="headerlink" title="10 Aggregations"></a>10 Aggregations</h2><p>按照目的地进行分桶统计<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">	"size": 0,</span><br><span class="line">	"aggs":&#123;</span><br><span class="line">		"flight_dest":&#123;</span><br><span class="line">			"terms":&#123;</span><br><span class="line">				"field":"DestCountry"</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查看航班目的地的统计信息，增加平均，最高最低价格<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">	"size": 0,</span><br><span class="line">	"aggs":&#123;</span><br><span class="line">		"flight_dest":&#123;</span><br><span class="line">			"terms":&#123;</span><br><span class="line">				"field":"DestCountry"</span><br><span class="line">			&#125;,</span><br><span class="line">			"aggs":&#123;</span><br><span class="line">				"avg_price":&#123;</span><br><span class="line">					"avg":&#123;</span><br><span class="line">						"field":"AvgTicketPrice"</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				"max_price":&#123;</span><br><span class="line">					"max":&#123;</span><br><span class="line">						"field":"AvgTicketPrice"</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				"min_price":&#123;</span><br><span class="line">					"min":&#123;</span><br><span class="line">						"field":"AvgTicketPrice"</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>价格统计信息+天气信息<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">	"size": 0,</span><br><span class="line">	"aggs":&#123;</span><br><span class="line">		"flight_dest":&#123;</span><br><span class="line">			"terms":&#123;</span><br><span class="line">				"field":"DestCountry"</span><br><span class="line">			&#125;,</span><br><span class="line">			"aggs":&#123;</span><br><span class="line">				"stats_price":&#123;</span><br><span class="line">					"stats":&#123;</span><br><span class="line">						"field":"AvgTicketPrice"</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				"wather":&#123;</span><br><span class="line">				  "terms": &#123;</span><br><span class="line">				    "field": "DestWeather",</span><br><span class="line">				    "size": 5</span><br><span class="line">				  &#125;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="11-案例"><a href="#11-案例" class="headerlink" title="11 案例"></a>11 案例</h2><h3 id="11-1-Term-查询"><a href="#11-1-Term-查询" class="headerlink" title="11.1 Term 查询"></a>11.1 Term 查询</h3><p>数据准备<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">DELETE products</span><br><span class="line">PUT products</span><br><span class="line">&#123;</span><br><span class="line">  "settings": &#123;</span><br><span class="line">    "number_of_shards": 1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /products/_bulk</span><br><span class="line">&#123; "index": &#123; "_id": 1 &#125;&#125;</span><br><span class="line">&#123; "productID" : "XHDK-A-1293-#fJ3","desc":"iPhone" &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 2 &#125;&#125;</span><br><span class="line">&#123; "productID" : "KDKE-B-9947-#kL5","desc":"iPad" &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 3 &#125;&#125;</span><br><span class="line">&#123; "productID" : "JODL-X-1937-#pV7","desc":"MBP" &#125;</span><br><span class="line"></span><br><span class="line">GET /products</span><br><span class="line">GET /products/_mapping</span><br></pre></td></tr></table></figure></p>
<p>查询<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "term": &#123;</span><br><span class="line">      "desc": &#123;</span><br><span class="line">        //"value": "iPhone"</span><br><span class="line">        "value":"iphone"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "term": &#123;</span><br><span class="line">      "desc.keyword": &#123;</span><br><span class="line">        //"value": "iPhone"</span><br><span class="line">        "value":"iphone"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "term": &#123;</span><br><span class="line">      "productID": &#123;</span><br><span class="line">        "value": "XHDK-A-1293-#fJ3"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  "explain": true,</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "term": &#123;</span><br><span class="line">      "productID.keyword": &#123;</span><br><span class="line">        "value": "XHDK-A-1293-#fJ3"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>跳过算分，提高查询效率<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  "explain": true,</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "constant_score": &#123;</span><br><span class="line">      "filter": &#123;</span><br><span class="line">        "term": &#123;</span><br><span class="line">          "productID.keyword": "XHDK-A-1293-#fJ3"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="11-2-全文查询"><a href="#11-2-全文查询" class="headerlink" title="11.2 全文查询"></a>11.2 全文查询</h3><p>参考博客</p>
<p><a href="https://blog.csdn.net/chuan442616909/article/details/56664861" target="_blank" rel="noopener">https://blog.csdn.net/chuan442616909/article/details/56664861</a></p>
<p>设置 position_increment_gap，解决数组查询问题<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">DELETE groups</span><br><span class="line">PUT groups</span><br><span class="line">&#123;</span><br><span class="line">  "mappings": &#123;</span><br><span class="line">    "properties": &#123;</span><br><span class="line">      "names":&#123;</span><br><span class="line">        "type": "text",</span><br><span class="line">        "position_increment_gap": 0</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET groups/_mapping</span><br><span class="line"></span><br><span class="line">POST groups/_doc</span><br><span class="line">&#123;</span><br><span class="line">  "names": [ "John Water", "Water Smith"]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST groups/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match_phrase": &#123;</span><br><span class="line">      "names": &#123;</span><br><span class="line">        "query": "Water Water",</span><br><span class="line">        "slop": 100</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST groups/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match_phrase": &#123;</span><br><span class="line">      "names": "Water Smith"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="11-3-结构化查询"><a href="#11-3-结构化查询" class="headerlink" title="11.3 结构化查询"></a>11.3 结构化查询</h3><p>数据准备<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">DELETE products</span><br><span class="line">POST /products/_bulk</span><br><span class="line">&#123; "index": &#123; "_id": 1 &#125;&#125;</span><br><span class="line">&#123; "price" : 10,"avaliable":true,"date":"2018-01-01", "productID" : "XHDK-A-1293-#fJ3" &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 2 &#125;&#125;</span><br><span class="line">&#123; "price" : 20,"avaliable":true,"date":"2019-01-01", "productID" : "KDKE-B-9947-#kL5" &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 3 &#125;&#125;</span><br><span class="line">&#123; "price" : 30,"avaliable":true, "productID" : "JODL-X-1937-#pV7" &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 4 &#125;&#125;</span><br><span class="line">&#123; "price" : 30,"avaliable":false, "productID" : "QQPX-R-3956-#aD8" &#125;</span><br><span class="line"></span><br><span class="line">GET products/_mapping</span><br></pre></td></tr></table></figure></p>
<p>对布尔值 match 查询，有算分<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  "profile": "true",</span><br><span class="line">  "explain": true,</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "term": &#123;</span><br><span class="line">      "avaliable": true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对布尔值，通过 constant score 转成 filtering，没有算分<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  "profile": "true",</span><br><span class="line">  "explain": true,</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "constant_score": &#123;</span><br><span class="line">      "filter": &#123;</span><br><span class="line">        "term": &#123;</span><br><span class="line">          "avaliable": true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>数字类型 Term 精确查询<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  "profile": "true",</span><br><span class="line">  "explain": true,</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "term": &#123;</span><br><span class="line">      "price": 30</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>数字类型 terms 精确查询<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "constant_score": &#123;</span><br><span class="line">      "filter": &#123;</span><br><span class="line">        "terms": &#123;</span><br><span class="line">          "price": [</span><br><span class="line">            "20",</span><br><span class="line">            "30"</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>数字 Range 查询<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET products/_search</span><br><span class="line">&#123;</span><br><span class="line">    "query" : &#123;</span><br><span class="line">        "constant_score" : &#123;</span><br><span class="line">            "filter" : &#123;</span><br><span class="line">                "range" : &#123;</span><br><span class="line">                    "price" : &#123;</span><br><span class="line">                        "gte" : 20,</span><br><span class="line">                        "lte"  : 30</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>日期 range，大于或等于现在减一年<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">    "query" : &#123;</span><br><span class="line">        "constant_score" : &#123;</span><br><span class="line">            "filter" : &#123;</span><br><span class="line">                "range" : &#123;</span><br><span class="line">                    "date" : &#123;</span><br><span class="line">                      "gte" : "now-1y"</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>文档是否存在字段查询<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "constant_score": &#123;</span><br><span class="line">      "filter": &#123;</span><br><span class="line">        "exists": &#123;</span><br><span class="line">          "field": "date"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>多值字段查询数据准备<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /movies/_bulk</span><br><span class="line">&#123; "index": &#123; "_id": 1 &#125;&#125;</span><br><span class="line">&#123; "title" : "Father of the Bridge Part II","year":1995, "genre":"Comedy"&#125;</span><br><span class="line">&#123; "index": &#123; "_id": 2 &#125;&#125;</span><br><span class="line">&#123; "title" : "Dave","year":1993,"genre":["Comedy","Romance"] &#125;</span><br></pre></td></tr></table></figure></p>
<p>处理多值字段，term 查询是包含，而不是等于<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "constant_score": &#123;</span><br><span class="line">      "filter": &#123;</span><br><span class="line">        "term": &#123;</span><br><span class="line">          "genre.keyword": "Comedy"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>字符类型 terms<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "constant_score": &#123;</span><br><span class="line">      "filter": &#123;</span><br><span class="line">        "terms": &#123;</span><br><span class="line">          "productID.keyword": [</span><br><span class="line">            "QQPX-R-3956-#aD8",</span><br><span class="line">            "JODL-X-1937-#pV7"</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>根据布尔数值进行算分<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "constant_score": &#123;</span><br><span class="line">      "filter": &#123;</span><br><span class="line">        "term": &#123;</span><br><span class="line">          "avaliable": "false"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="11-4-相关性算分查询"><a href="#11-4-相关性算分查询" class="headerlink" title="11.4 相关性算分查询"></a>11.4 相关性算分查询</h3><p>参数 boost 的含义</p>
<ol>
<li>当 boost &gt; 1 时，打分的相关度相对性提升</li>
<li>当 0 &lt; boost &lt; 1 时，打分的权重相对性降低</li>
<li>当 boost &lt; 0 时，贡献负分</li>
</ol>
<p>数据准备<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">PUT testscore</span><br><span class="line">&#123;</span><br><span class="line">  "settings": &#123;</span><br><span class="line">    "number_of_shards": 1</span><br><span class="line">  &#125;,</span><br><span class="line">  "mappings": &#123;</span><br><span class="line">    "properties": &#123;</span><br><span class="line">      "content": &#123;</span><br><span class="line">        "type": "text"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT testscore/_bulk</span><br><span class="line">&#123; "index": &#123; "_id": 1 &#125;&#125;</span><br><span class="line">&#123; "content":"we use Elasticsearch to power the search" &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 2 &#125;&#125;</span><br><span class="line">&#123; "content":"we like elasticsearch" &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 3 &#125;&#125;</span><br><span class="line">&#123; "content":"The scoring of documents is caculated by the scoring formula" &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 4 &#125;&#125;</span><br><span class="line">&#123; "content":"you know, for search" &#125;</span><br></pre></td></tr></table></figure></p>
<p>查询<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST testscore/_search</span><br><span class="line">&#123;</span><br><span class="line">    "query": &#123;</span><br><span class="line">        "boosting" : &#123;</span><br><span class="line">            "positive" : &#123;</span><br><span class="line">                "term" : &#123;</span><br><span class="line">                    "content" : "elasticsearch"</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            "negative" : &#123;</span><br><span class="line">                 "term" : &#123;</span><br><span class="line">                     "content" : "like"</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            "negative_boost" : 0.2</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="11-5-复合查询"><a href="#11-5-复合查询" class="headerlink" title="11.5 复合查询"></a>11.5 复合查询</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /products/_bulk</span><br><span class="line">&#123; "index": &#123; "_id": 1 &#125;&#125;</span><br><span class="line">&#123; "price" : 10,"avaliable":true,"date":"2018-01-01", "productID" : "XHDK-A-1293-#fJ3" &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 2 &#125;&#125;</span><br><span class="line">&#123; "price" : 20,"avaliable":true,"date":"2019-01-01", "productID" : "KDKE-B-9947-#kL5" &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 3 &#125;&#125;</span><br><span class="line">&#123; "price" : 30,"avaliable":true, "productID" : "JODL-X-1937-#pV7" &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 4 &#125;&#125;</span><br><span class="line">&#123; "price" : 30,"avaliable":false, "productID" : "QQPX-R-3956-#aD8" &#125;</span><br></pre></td></tr></table></figure>
<p>基本语法<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "bool" : &#123;</span><br><span class="line">      "must" : &#123;</span><br><span class="line">        "term" : &#123; "price" : "30" &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "filter": &#123;</span><br><span class="line">        "term" : &#123; "avaliable" : "true" &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "must_not" : &#123;</span><br><span class="line">        "range" : &#123;</span><br><span class="line">          "price" : &#123; "lte" : 10 &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "should" : [</span><br><span class="line">        &#123; "term" : &#123; "productID.keyword" : "JODL-X-1937-#pV7" &#125; &#125;,</span><br><span class="line">        &#123; "term" : &#123; "productID.keyword" : "XHDK-A-1293-#fJ3" &#125; &#125;</span><br><span class="line">      ],</span><br><span class="line">      "minimum_should_match" :1</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>改变数据模型，增加字段。解决数组包含而不是精确匹配的问题<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /newmovies/_bulk</span><br><span class="line">&#123; "index": &#123; "_id": 1 &#125;&#125;</span><br><span class="line">&#123; "title" : "Father of the Bridge Part II","year":1995, "genre":"Comedy","genre_count":1 &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 2 &#125;&#125;</span><br><span class="line">&#123; "title" : "Dave","year":1993,"genre":["Comedy","Romance"],"genre_count":2 &#125;</span><br></pre></td></tr></table></figure></p>
<p>must，有算分<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST /newmovies/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "bool": &#123;</span><br><span class="line">      "must": [</span><br><span class="line">        &#123;"term": &#123;"genre.keyword": &#123;"value": "Comedy"&#125;&#125;&#125;,</span><br><span class="line">        &#123;"term": &#123;"genre_count": &#123;"value": 1&#125;&#125;&#125;</span><br><span class="line"></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Filter。不参与算分，结果的score是0<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST /newmovies/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "bool": &#123;</span><br><span class="line">      "filter": [</span><br><span class="line">        &#123;"term": &#123;"genre.keyword": &#123;"value": "Comedy"&#125;&#125;&#125;,</span><br><span class="line">        &#123;"term": &#123;"genre_count": &#123;"value": 1&#125;&#125;&#125;</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Filtering Context<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST _search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "bool" : &#123;</span><br><span class="line"></span><br><span class="line">      "filter": &#123;</span><br><span class="line">        "term" : &#123; "avaliable" : "true" &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "must_not" : &#123;</span><br><span class="line">        "range" : &#123;</span><br><span class="line">          "price" : &#123; "lte" : 10 &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Query Context<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">POST /products/_bulk</span><br><span class="line">&#123; "index": &#123; "_id": 1 &#125;&#125;</span><br><span class="line">&#123; "price" : 10,"avaliable":true,"date":"2018-01-01", "productID" : "XHDK-A-1293-#fJ3" &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 2 &#125;&#125;</span><br><span class="line">&#123; "price" : 20,"avaliable":true,"date":"2019-01-01", "productID" : "KDKE-B-9947-#kL5" &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 3 &#125;&#125;</span><br><span class="line">&#123; "price" : 30,"avaliable":true, "productID" : "JODL-X-1937-#pV7" &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 4 &#125;&#125;</span><br><span class="line">&#123; "price" : 30,"avaliable":false, "productID" : "QQPX-R-3956-#aD8" &#125;</span><br><span class="line"></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "bool": &#123;</span><br><span class="line">      "should": [</span><br><span class="line">        &#123;</span><br><span class="line">          "term": &#123;</span><br><span class="line">            "productID.keyword": &#123;</span><br><span class="line">              "value": "JODL-X-1937-#pV7"&#125;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;"term": &#123;"avaliable": &#123;"value": true&#125;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>嵌套，实现了 should not 逻辑<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "bool": &#123;</span><br><span class="line">      "must": &#123;</span><br><span class="line">        "term": &#123;</span><br><span class="line">          "price": "30"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "should": [</span><br><span class="line">        &#123;</span><br><span class="line">          "bool": &#123;</span><br><span class="line">            "must_not": &#123;</span><br><span class="line">              "term": &#123;</span><br><span class="line">                "avaliable": "false"</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      "minimum_should_match": 1</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Controll the Precision<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">POST _search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "bool" : &#123;</span><br><span class="line">      "must" : &#123;</span><br><span class="line">        "term" : &#123; "price" : "30" &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "filter": &#123;</span><br><span class="line">        "term" : &#123; "avaliable" : "true" &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "must_not" : &#123;</span><br><span class="line">        "range" : &#123;</span><br><span class="line">          "price" : &#123; "lte" : 10 &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "should" : [</span><br><span class="line">        &#123; "term" : &#123; "productID.keyword" : "JODL-X-1937-#pV7" &#125; &#125;,</span><br><span class="line">        &#123; "term" : &#123; "productID.keyword" : "XHDK-A-1293-#fJ3" &#125; &#125;</span><br><span class="line">      ],</span><br><span class="line">      "minimum_should_match" :2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">DELETE blogs</span><br><span class="line">POST /blogs/_bulk</span><br><span class="line">&#123; "index": &#123; "_id": 1 &#125;&#125;</span><br><span class="line">&#123;"title":"Apple iPad", "content":"Apple iPad,Apple iPad" &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 2 &#125;&#125;</span><br><span class="line">&#123;"title":"Apple iPad,Apple iPad", "content":"Apple iPad" &#125;</span><br><span class="line"></span><br><span class="line">POST blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "bool": &#123;</span><br><span class="line">      "should": [</span><br><span class="line">        &#123;"match": &#123;</span><br><span class="line">          "title": &#123;</span><br><span class="line">            "query": "apple,ipad",</span><br><span class="line">            "boost": 1.1</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;&#125;,</span><br><span class="line">        &#123;"match": &#123;</span><br><span class="line">          "content": &#123;</span><br><span class="line">            "query": "apple,ipad",</span><br><span class="line">            "boost": 2</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DELETE news</span><br><span class="line">POST /news/_bulk</span><br><span class="line">&#123; "index": &#123; "_id": 1 &#125;&#125;</span><br><span class="line">&#123; "content":"Apple Mac" &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 2 &#125;&#125;</span><br><span class="line">&#123; "content":"Apple iPad" &#125;</span><br><span class="line">&#123; "index": &#123; "_id": 3 &#125;&#125;</span><br><span class="line">&#123; "content":"Apple employee like Apple Pie and Apple Juice" &#125;</span><br><span class="line"></span><br><span class="line">POST news/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "bool": &#123;</span><br><span class="line">      "must": &#123;</span><br><span class="line">        "match":&#123;"content":"apple"&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST news/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "bool": &#123;</span><br><span class="line">      "must": &#123;</span><br><span class="line">        "match":&#123;"content":"apple"&#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "must_not": &#123;</span><br><span class="line">        "match":&#123;"content":"pie"&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST news/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "boosting": &#123;</span><br><span class="line">      "positive": &#123;</span><br><span class="line">        "match": &#123;</span><br><span class="line">          "content": "apple"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "negative": &#123;</span><br><span class="line">        "match": &#123;</span><br><span class="line">          "content": "pie"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "negative_boost": 0.5</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="11-6-Disjunction-Max-Query"><a href="#11-6-Disjunction-Max-Query" class="headerlink" title="11.6 Disjunction Max Query"></a>11.6 Disjunction Max Query</h3><p>将任何与任一查询匹配的文档作为结果返回。采用字段上最匹配的评分最终评分返回。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">PUT /blogs/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">    "title": "Quick brown rabbits",</span><br><span class="line">    "body":  "Brown rabbits are commonly seen."</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /blogs/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">    "title": "Keeping pets healthy",</span><br><span class="line">    "body":  "My quick brown fox eats rabbits on a regular basis."</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">    "query": &#123;</span><br><span class="line">        "bool": &#123;</span><br><span class="line">            "should": [</span><br><span class="line">                &#123; "match": &#123; "title": "Brown fox" &#125;&#125;,</span><br><span class="line">                &#123; "match": &#123; "body":  "Brown fox" &#125;&#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">    "query": &#123;</span><br><span class="line">        "dis_max": &#123;</span><br><span class="line">            "queries": [</span><br><span class="line">                &#123; "match": &#123; "title": "Brown fox" &#125;&#125;,</span><br><span class="line">                &#123; "match": &#123; "body":  "Brown fox" &#125;&#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">    "query": &#123;</span><br><span class="line">        "dis_max": &#123;</span><br><span class="line">            "queries": [</span><br><span class="line">                &#123; "match": &#123; "title": "Quick pets" &#125;&#125;,</span><br><span class="line">                &#123; "match": &#123; "body":  "Quick pets" &#125;&#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">    "query": &#123;</span><br><span class="line">        "dis_max": &#123;</span><br><span class="line">            "queries": [</span><br><span class="line">                &#123; "match": &#123; "title": "Quick pets" &#125;&#125;,</span><br><span class="line">                &#123; "match": &#123; "body":  "Quick pets" &#125;&#125;</span><br><span class="line">            ],</span><br><span class="line">            "tie_breaker": 0.2</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="11-7-Multi-Match"><a href="#11-7-Multi-Match" class="headerlink" title="11.7 Multi Match"></a>11.7 Multi Match</h3><h3 id="11-8-Function-Score-Query"><a href="#11-8-Function-Score-Query" class="headerlink" title="11.8 Function Score Query"></a>11.8 Function Score Query</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">DELETE blogs</span><br><span class="line">PUT /blogs/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  "title":   "About popularity",</span><br><span class="line">  "content": "In this post we will talk about...",</span><br><span class="line">  "votes":   0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /blogs/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  "title":   "About popularity",</span><br><span class="line">  "content": "In this post we will talk about...",</span><br><span class="line">  "votes":   100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /blogs/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  "title":   "About popularity",</span><br><span class="line">  "content": "In this post we will talk about...",</span><br><span class="line">  "votes":   1000000</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "function_score": &#123;</span><br><span class="line">      "query": &#123;</span><br><span class="line">        "multi_match": &#123;</span><br><span class="line">          "query":    "popularity",</span><br><span class="line">          "fields": [ "title", "content" ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "field_value_factor": &#123;</span><br><span class="line">        "field": "votes"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "function_score": &#123;</span><br><span class="line">      "query": &#123;</span><br><span class="line">        "multi_match": &#123;</span><br><span class="line">          "query":    "popularity",</span><br><span class="line">          "fields": [ "title", "content" ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "field_value_factor": &#123;</span><br><span class="line">        "field": "votes",</span><br><span class="line">        "modifier": "log1p"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "function_score": &#123;</span><br><span class="line">      "query": &#123;</span><br><span class="line">        "multi_match": &#123;</span><br><span class="line">          "query":    "popularity",</span><br><span class="line">          "fields": [ "title", "content" ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "field_value_factor": &#123;</span><br><span class="line">        "field": "votes",</span><br><span class="line">        "modifier": "log1p" ,</span><br><span class="line">        "factor": 0.1</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "function_score": &#123;</span><br><span class="line">      "query": &#123;</span><br><span class="line">        "multi_match": &#123;</span><br><span class="line">          "query":    "popularity",</span><br><span class="line">          "fields": [ "title", "content" ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "field_value_factor": &#123;</span><br><span class="line">        "field": "votes",</span><br><span class="line">        "modifier": "log1p" ,</span><br><span class="line">        "factor": 0.1</span><br><span class="line">      &#125;,</span><br><span class="line">      "boost_mode": "sum",</span><br><span class="line">      "max_boost": 3</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "function_score": &#123;</span><br><span class="line">      "random_score": &#123;</span><br><span class="line">        "seed": 911119</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="12-Aliases"><a href="#12-Aliases" class="headerlink" title="12 Aliases"></a>12 Aliases</h2><p>数据准备<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT movies-2019/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  "name":"the matrix",</span><br><span class="line">  "rating":5</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT movies-2019/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  "name":"Speed",</span><br><span class="line">  "rating":3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>设置索引的别名<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">POST _aliases</span><br><span class="line">&#123;</span><br><span class="line">  "actions": [</span><br><span class="line">    &#123;</span><br><span class="line">      "add": &#123;</span><br><span class="line">        "index": "movies-2019",</span><br><span class="line">        "alias": "movies-latest"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST _aliases</span><br><span class="line">&#123;</span><br><span class="line">  "actions": [</span><br><span class="line">    &#123;</span><br><span class="line">      "add": &#123;</span><br><span class="line">        "index": "movies-2019",</span><br><span class="line">        "alias": "movies-lastest-highrate",</span><br><span class="line">        "filter": &#123;</span><br><span class="line">          "range": &#123;</span><br><span class="line">            "rating": &#123;</span><br><span class="line">              "gte": 4</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>根据别名查询<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST movies-latest/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match_all": &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST movies-lastest-highrate/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match_all": &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="13-Scripting"><a href="#13-Scripting" class="headerlink" title="13 Scripting"></a>13 Scripting</h2><p>使用场景：在开发初期，虽然可以明确查询参数，但是往往还不不能最终定义查询的 DSL 的具体结构。</p>
<p>定义查询模板<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST _scripts/tmdb</span><br><span class="line">&#123;</span><br><span class="line">  "script": &#123;</span><br><span class="line">    "lang": "mustache",</span><br><span class="line">    "source": &#123;</span><br><span class="line">      "_source": [</span><br><span class="line">        "title","overview"</span><br><span class="line">      ],</span><br><span class="line">      "size": 20,</span><br><span class="line">      "query": &#123;</span><br><span class="line">        "multi_match": &#123;</span><br><span class="line">          "query": "&#123;&#123;q&#125;&#125;",</span><br><span class="line">          "fields": ["title","overview"]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用查询模板查询<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST tmdb/_search/template</span><br><span class="line">&#123;</span><br><span class="line">    "id":"tmdb",</span><br><span class="line">    "params": &#123;</span><br><span class="line">        "q": "basketball with cartoon aliens"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

    </div>
    
    <div class="post-footer">
        <div class="col-sm-10">
            <div>
                <b>本文链接</b>：<a href="/2019/09/28/Elasticsearch常用API/">Elasticsearch常用API</a>
            </div>
            <div>
                
                    转载声明：本博客由<strong>哲锄</strong>创作，采用 <a href="https://creativecommons.org/licenses/by-nc-nd/3.0/" target="_blank"> CC BY 3.0 CN </a> 许可协议。可自由转载、引用，但需署名作者且注明文章出处。如转载至微信公众号，请在文末添加作者公众号二维码。
                
            </div>
            <div>
                
            </div>
        </div>
        <div class="col-sm-2">
            <img src="" width=100%/>
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/2019/10/01/Elasticsearch常用分词器/" class="pre-post btn btn-default" title='Elasticsearch常用分词器'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">Elasticsearch常用分词器</span>
        </a>
    
    
        <a href="/2019/09/23/结构型-装饰模式/" class="next-post btn btn-default" title='结构型-装饰模式'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">结构型-装饰模式</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>






                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-cat-APIs"><span class="toc-text">1 cat APIs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-通用参数"><span class="toc-text">1.1 通用参数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-1-Verbose"><span class="toc-text">1.1.1 Verbose</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-2-Sort"><span class="toc-text">1.1.2 Sort</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Indices-APIs"><span class="toc-text">2 Indices APIs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Search-APIs"><span class="toc-text">3 Search APIs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Cluster-APIs"><span class="toc-text">4 Cluster APIs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Document-APIs"><span class="toc-text">5 Document APIs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-创建文档"><span class="toc-text">5.1 创建文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-删除文档"><span class="toc-text">5.2 删除文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-更新文档"><span class="toc-text">5.3 更新文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-查询文档"><span class="toc-text">5.4 查询文档</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Analysis"><span class="toc-text">6 Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-Analyzer"><span class="toc-text">6.1 Analyzer</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-Query-DSL"><span class="toc-text">7 Query DSL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-Query-string-query"><span class="toc-text">7.1 Query string query</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-Mapping"><span class="toc-text">8 Mapping</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-Dynamic-Mapping"><span class="toc-text">8.1 Dynamic Mapping</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-Mapping-定义"><span class="toc-text">8.2 Mapping 定义</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-Index-Templates"><span class="toc-text">9 Index Templates</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-Aggregations"><span class="toc-text">10 Aggregations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-案例"><span class="toc-text">11 案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-1-Term-查询"><span class="toc-text">11.1 Term 查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-2-全文查询"><span class="toc-text">11.2 全文查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-3-结构化查询"><span class="toc-text">11.3 结构化查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-4-相关性算分查询"><span class="toc-text">11.4 相关性算分查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-5-复合查询"><span class="toc-text">11.5 复合查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-6-Disjunction-Max-Query"><span class="toc-text">11.6 Disjunction Max Query</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-7-Multi-Match"><span class="toc-text">11.7 Multi Match</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-8-Function-Score-Query"><span class="toc-text">11.8 Function Score Query</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-Aliases"><span class="toc-text">12 Aliases</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-Scripting"><span class="toc-text">13 Scripting</span></a></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
        访问量:
        <strong id="busuanzi_value_site_pv">
            <i class="fa fa-spinner fa-spin"></i>
        </strong>
        &nbsp; | &nbsp;
        访客数:
        <strong id="busuanzi_value_site_uv">
            <i class="fa fa-spinner fa-spin"></i>
        </strong>
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2016
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/itmuch/hexo-theme-itmuch.git" class="copyright-links" target="_blank" rel="nofollow">ITMuch</a>
                </span>
            </div>
        </div>
    </div>
</div>






    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>