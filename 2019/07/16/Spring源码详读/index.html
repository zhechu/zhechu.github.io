<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="哲锄">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="https://zhechu.github.io">
    <!--SEO-->

    <meta name="keywords" content="Spring,">


    <meta name="description" content="环境说明



环境
说明




spring-5.0.x
企业应用程序框架



官方文档
https://docs.spring.io/spring/docs/5.0.15.RELEASE/spring-framework-reference/
Spring 源码中文注释
https:/...">


<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">
    <!--Title-->


<title>Spring源码详读 | 哲锄</title>


    <link rel="alternate" href="/atom.xml" title="哲锄" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    





    

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="https://zhechu.github.io">哲锄</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa fa-home"></i>哲锄</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories"><i class="fa fa-list"></i>分类</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/about"><i class="fa fa-user"></i>关于我</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/archives"><i class="fa fa-archive"></i>归档</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>

<a href="http://github.com/zhechu">
    <img style="position: absolute; top: 0; right: 0; border: 0;"
        src="/img/forkme.png"
        alt="Fork me on GitHub">
</a>

    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="Spring源码详读">
            
                Spring源码详读
            
        </h1>
        <div class="post-meta">
    
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a href="/categories/Java">
            Java
        </a>
    </span>
    

    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
                
                    <a href="/tags/Spring" title='Spring'>
                        Spring
                    </a>
                
            
        </span>
    </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2019/07/16</span>
        </span>
        
            <span class="fa-wrap">
                <i class="fa fa-eye"></i>
                <span id="busuanzi_value_page_pv"></span>
            </span>
        
    
</div>

        
        
    </div>
    
    <div class="post-body post-content">
        <p>环境说明</p>
<table>
<thead>
<tr>
<th>环境</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>spring-5.0.x</td>
<td>企业应用程序框架</td>
</tr>
</tbody>
</table>
<p>官方文档</p>
<p><a href="https://docs.spring.io/spring/docs/5.0.15.RELEASE/spring-framework-reference/" target="_blank" rel="noopener">https://docs.spring.io/spring/docs/5.0.15.RELEASE/spring-framework-reference/</a></p>
<p>Spring 源码中文注释</p>
<p><a href="https://github.com/zhechu/spring-framework-5.0.x" target="_blank" rel="noopener">https://github.com/zhechu/spring-framework-5.0.x</a></p>
<p>Spring Boot 源码中文注释</p>
<p><a href="https://github.com/zhechu/spring-boot-2.1.5.RELEASE" target="_blank" rel="noopener">https://github.com/zhechu/spring-boot-2.1.5.RELEASE</a></p>
<h2 id="1-注册组件"><a href="#1-注册组件" class="headerlink" title="1 注册组件"></a>1 注册组件</h2><h3 id="1-1-ComponentScan-包扫描-组件标注注解"><a href="#1-1-ComponentScan-包扫描-组件标注注解" class="headerlink" title="1.1 @ComponentScan-包扫描+组件标注注解"></a>1.1 @ComponentScan-包扫描+组件标注注解</h3><p>包扫描+组件标注注解（@Controller/@Service/@Repository/@Component）。</p>
<blockquote>
<p>@ComponentScan 示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"com.wise.controller"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>@ComponentScans 示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置类==配置文件</span></span><br><span class="line"><span class="meta">@Configuration</span>  <span class="comment">// 告诉Spring这是一个配置类</span></span><br><span class="line"><span class="meta">@ComponentScans</span>(</span><br><span class="line">		value = &#123;</span><br><span class="line">				<span class="meta">@ComponentScan</span>(value=<span class="string">"com.wise"</span>,includeFilters = &#123;</span><br><span class="line">						<span class="meta">@Filter</span>(type=FilterType.ANNOTATION,classes=&#123;Controller<span class="class">.<span class="keyword">class</span>&#125;),</span></span><br><span class="line"><span class="class">						@<span class="title">Filter</span>(<span class="title">type</span></span>=FilterType.ASSIGNABLE_TYPE,classes=&#123;BookService<span class="class">.<span class="keyword">class</span>&#125;),</span></span><br><span class="line"><span class="class">						@<span class="title">Filter</span>(<span class="title">type</span></span>=FilterType.CUSTOM,classes=&#123;MyTypeFilter<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">				&#125;,<span class="title">useDefaultFilters</span> </span>= <span class="keyword">false</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		)</span><br><span class="line"><span class="comment">//@ComponentScan  value:指定要扫描的包</span></span><br><span class="line"><span class="comment">//excludeFilters = Filter[] ：指定扫描的时候按照什么规则排除那些组件</span></span><br><span class="line"><span class="comment">//includeFilters = Filter[] ：指定扫描的时候只需要包含哪些组件</span></span><br><span class="line"><span class="comment">//FilterType.ANNOTATION：按照注解</span></span><br><span class="line"><span class="comment">//FilterType.ASSIGNABLE_TYPE：按照给定的类型；</span></span><br><span class="line"><span class="comment">//FilterType.ASPECTJ：使用ASPECTJ表达式</span></span><br><span class="line"><span class="comment">//FilterType.REGEX：使用正则指定</span></span><br><span class="line"><span class="comment">//FilterType.CUSTOM：使用自定义规则</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 给容器中注册一个Bean;类型为返回值的类型，id默认是用方法名作为id */</span></span><br><span class="line">	<span class="meta">@Bean</span>(<span class="string">"person"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Person <span class="title">person01</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Person(<span class="string">"lisi"</span>, <span class="number">20</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTypeFilter</span> <span class="keyword">implements</span> <span class="title">TypeFilter</span> </span>&#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * metadataReader：读取到的当前正在扫描的类的信息</span></span><br><span class="line"><span class="comment">	 * metadataReaderFactory:可以获取到其他任何类信息的</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">match</span><span class="params">(MetadataReader metadataReader, MetadataReaderFactory metadataReaderFactory)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="comment">//获取当前类注解的信息</span></span><br><span class="line">		AnnotationMetadata annotationMetadata = metadataReader.getAnnotationMetadata();</span><br><span class="line">		<span class="comment">//获取当前正在扫描的类的类信息</span></span><br><span class="line">		ClassMetadata classMetadata = metadataReader.getClassMetadata();</span><br><span class="line">		<span class="comment">//获取当前类资源（类的路径）</span></span><br><span class="line">		Resource resource = metadataReader.getResource();</span><br><span class="line"></span><br><span class="line">		String className = classMetadata.getClassName();</span><br><span class="line">		System.out.println(<span class="string">"---&gt;"</span>+className);</span><br><span class="line">		<span class="keyword">if</span>(className.contains(<span class="string">"er"</span>))&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-Bean"><a href="#1-2-Bean" class="headerlink" title="1.2 @Bean"></a>1.2 @Bean</h3><p>通常用于导入的第三方包里面的组件。</p>
<h3 id="1-3-Import"><a href="#1-3-Import" class="headerlink" title="1.3 @Import"></a>1.3 @Import</h3><ol>
<li>@Import(要导入到容器中的组件)；容器中就会自动注册这个组件，id 默认是全类名</li>
<li>ImportSelector:返回需要导入的组件的全类名数组；</li>
<li>ImportBeanDefinitionRegistrar:手动注册 bean 到容器中，官方示例 <code>AspectJAutoProxyRegistrar</code></li>
</ol>
<blockquote>
<p>@Import 示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.wise.controller.ImportController;</span><br><span class="line"><span class="keyword">import</span> com.wise.service.ImportService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Import;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import</span>(&#123;ImportService<span class="class">.<span class="keyword">class</span>, <span class="title">ImportController</span>.<span class="title">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">AnnotationConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>@Import + ImportSelector 示例</p>
</blockquote>
<p>自定义 ImportSelector 类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ImportSelector;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.AnnotationMetadata;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义逻辑返回需要导入的组件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomImportSelector</span> <span class="keyword">implements</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 返回值，就是到导入到容器中的组件全类名</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> importingClassMetadata 当前标注<span class="doctag">@Import</span>注解的类的所有注解信息</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> String[]&#123;<span class="string">"com.wise.controller.ImportController"</span>&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.wise.selector.CustomImportSelector;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Import;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import</span>(&#123;CustomImportSelector<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">AnnotationConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>@Import + ImportBeanDefinitionRegistrar 示例</p>
</blockquote>
<p>自定义 ImportBeanDefinitionRegistrar 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.wise.controller.RegistrarController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.BeanDefinitionRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.RootBeanDefinition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ImportBeanDefinitionRegistrar;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.AnnotationMetadata;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomImportBeanDefinitionRegistrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> importingClassMetadata 当前类的注解信息</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> registry 注册类</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 判断是否已经定义，若还未注册，则执行注册逻辑</span></span><br><span class="line">		<span class="keyword">boolean</span> defined = registry.containsBeanDefinition(<span class="string">"com.wise.controller.RegistrarController"</span>);</span><br><span class="line">		<span class="keyword">if</span> (!defined) &#123;</span><br><span class="line">			<span class="comment">// 指定Bean定义信息</span></span><br><span class="line">			RootBeanDefinition registrarControllerBeanDefinition = <span class="keyword">new</span> RootBeanDefinition(RegistrarController<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">			<span class="comment">// 注册 Bean，指定 Bean 名</span></span><br><span class="line">			registry.registerBeanDefinition(<span class="string">"CustomRegistrarController"</span>, registrarControllerBeanDefinition);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.wise.registrar.CustomImportBeanDefinitionRegistrar;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Import;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import</span>(&#123;CustomImportBeanDefinitionRegistrar<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">AnnotationConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-4-FactoryBean"><a href="#1-4-FactoryBean" class="headerlink" title="1.4 FactoryBean"></a>1.4 FactoryBean</h3><blockquote>
<p>示例：自定义 FactoryBean</p>
</blockquote>
<p>自定义 FactoryBean 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.wise.controller.FactoryController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.FactoryBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ControllerFactoryBean</span> <span class="keyword">implements</span> <span class="title">FactoryBean</span>&lt;<span class="title">FactoryController</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 返回对象并加入 Spring 容器中</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> FactoryController <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"init factoryController instance"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> FactoryController();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">		<span class="keyword">return</span> FactoryController<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 是否为单例</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.wise.factory.ControllerFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将工厂 Bean 注入 Spring 容器，但其实际类型为 com.wise.controller.FactoryController</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ControllerFactoryBean <span class="title">controllerFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ControllerFactoryBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>单元测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">factoryBeanTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(AnnotationConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"container start up"</span>);</span><br><span class="line"></span><br><span class="line">    String[] beanDefinitionNames = applicationContext.getBeanDefinitionNames();</span><br><span class="line">    <span class="keyword">for</span> (String beanDefinitionName : beanDefinitionNames) &#123;</span><br><span class="line">        System.out.println(beanDefinitionName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 此时真正注册的 Bean 才会初始化</span></span><br><span class="line">    FactoryController factoryController = applicationContext.getBean(FactoryController<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    FactoryController factoryControllerTemp = applicationContext.getBean(FactoryController<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    System.out.println(factoryController == factoryControllerTemp);</span><br><span class="line">    factoryController.say(<span class="string">"zhangsan"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-Configuration-注册配置"><a href="#2-Configuration-注册配置" class="headerlink" title="2 @Configuration-注册配置"></a>2 @Configuration-注册配置</h2><h2 id="3-注册条件"><a href="#3-注册条件" class="headerlink" title="3 注册条件"></a>3 注册条件</h2><h3 id="3-1-Conditional"><a href="#3-1-Conditional" class="headerlink" title="3.1 @Conditional"></a>3.1 @Conditional</h3><p>示例：是在 Linux 系统上运行才注册</p>
<p>条件类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Condition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ConditionContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.AnnotatedTypeMetadata;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断是否windows系统</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowsCondition</span> <span class="keyword">implements</span> <span class="title">Condition</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> </span>&#123;</span><br><span class="line">		Environment environment = context.getEnvironment();</span><br><span class="line">		String property = environment.getProperty(<span class="string">"os.name"</span>);</span><br><span class="line">		<span class="keyword">if</span>(property.contains(<span class="string">"Windows"</span>))&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>配置类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.wise.bean.Person;</span><br><span class="line"><span class="keyword">import</span> com.wise.condition.LinuxCondition;</span><br><span class="line"><span class="keyword">import</span> com.wise.controller.LazyController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Conditional;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Lazy;</span><br><span class="line"></span><br><span class="line"><span class="comment">//@Conditional(&#123;WindowsCondition.class&#125;) // 满足当前条件，这个类中配置的所有 bean 注册才能生效</span></span><br><span class="line"><span class="meta">@Conditional</span>(&#123;LinuxCondition<span class="class">.<span class="keyword">class</span>&#125;) // 满足当前条件，这个类中配置的所有 <span class="title">bean</span> 注册才能生效</span></span><br><span class="line"><span class="class">@<span class="title">Configuration</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">AnnotationConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">person</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"person created"</span>);</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line">        person.setId(<span class="string">"1"</span>);</span><br><span class="line">        person.setName(<span class="string">"张三"</span>);</span><br><span class="line">        person.setAge(<span class="number">20</span>);</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Lazy</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LazyController <span class="title">lazyController</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"lazyController created"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LazyController();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="3-2-ConditionalOnProperty"><a href="#3-2-ConditionalOnProperty" class="headerlink" title="3.2 @ConditionalOnProperty"></a>3.2 @ConditionalOnProperty</h3><p><code>@ConditionalOnProperty</code> 为 <strong>Spring Boot</strong> 注解，可用于自定义 spring boot starter！</p>
<p>示例：自定义 spring boot starter</p>
<p>自动配置类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(&#123;</span><br><span class="line">        QiaokuCommonSmsProperties<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">        <span class="title">QiaokuCommonAliyunProperties</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">        <span class="title">QiaokuCommonRongCloudProperties</span>.<span class="title">class</span>&#125;)</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnProperty</span>(<span class="title">name</span> </span>= <span class="string">"qiaoku.common.enabled"</span>, matchIfMissing = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QiaokuCommonAutoConfigure</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<p>示例：Apollo 配置中心 configservice 组件是否启用 eureka</p>
<p>条件类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctrip.framework.apollo.configservice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Start Eureka Client annotations according to configuration</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Zhiqiang Lin(linzhiqiang0514@163.com)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(name = <span class="string">"apollo.eureka.client.enabled"</span>, havingValue = <span class="string">"true"</span>, matchIfMissing = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigServerEurekaClientConfigure</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>TIPS：Apollo 源码解析链接 <a href="http://www.iocoder.cn/categories/Apollo/" target="_blank" rel="noopener">http://www.iocoder.cn/categories/Apollo/</a></p>
</blockquote>
<h2 id="4-Lazy-懒注册"><a href="#4-Lazy-懒注册" class="headerlink" title="4 @Lazy-懒注册"></a>4 @Lazy-懒注册</h2><blockquote>
<p>Bean 延迟初始化示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Lazy</span> <span class="comment">// 第一次用时才注册</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LazyController <span class="title">lazyController</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"lazyController created"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LazyController();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>解决循环依赖示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拦截器，</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PunishInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Lazy</span> <span class="comment">// 解决循环依赖 BUG，Controller 中也依赖 UserService 导致间接循环依赖</span></span><br><span class="line">    UserService userService;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="5-Bean-的生命周期"><a href="#5-Bean-的生命周期" class="headerlink" title="5 Bean 的生命周期"></a>5 Bean 的生命周期</h2><h3 id="5-1-指定初始化和销毁方法"><a href="#5-1-指定初始化和销毁方法" class="headerlink" title="5.1 指定初始化和销毁方法"></a>5.1 指定初始化和销毁方法</h3><ol>
<li>通过 @Bean 指定 init-method 和 destroy-method</li>
<li>Bean 实现 InitializingBean（定义初始化逻辑）和 DisposableBean（定义销毁逻辑）</li>
<li>@PostConstruct 和 @PreDestroy</li>
<li>实现 BeanPostProcessor 接口。postProcessBeforeInitialization 方法在 init 方法被回调之前执行，postProcessAfterInitialization 在 init 方法被回调之后执行</li>
<li>实现 InstantiationAwareBeanPostProcessor 接口。postProcessBeforeInstantiation 在构造器之前执行，postProcessAfterInstantiation 在构造器之后执行，postProcessPropertyValues 在 postProcessAfterInstantiation 之后执行且在 postProcessBeforeInitialization 之前执行</li>
</ol>
<p>初始化：对象创建完成，并赋值好，调用初始化方法。</p>
<p>销毁：容器关闭的时候调用销毁方法。<strong>多实例下，容器不会调用销毁方法</strong>。</p>
<h4 id="5-1-1-示例：指定-init-method-和-destroy-method"><a href="#5-1-1-示例：指定-init-method-和-destroy-method" class="headerlink" title="5.1.1 示例：指定 init-method 和 destroy-method"></a>5.1.1 示例：指定 init-method 和 destroy-method</h4><p>Bean 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LifeCycleController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LifeCycleController</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"lifeCycleController constructor..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"lifeCycleController ... init..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">detory</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"lifeCycleController ... detory..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"hello "</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.wise.controller.LifeCycleController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(initMethod = <span class="string">"init"</span>, destroyMethod = <span class="string">"detory"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> LifeCycleController <span class="title">lifeCycleController</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LifeCycleController();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>单元测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lifeCycleTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(AnnotationConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"container start up"</span>);</span><br><span class="line"></span><br><span class="line">    String[] beanDefinitionNames = applicationContext.getBeanDefinitionNames();</span><br><span class="line">    <span class="keyword">for</span> (String beanDefinitionName : beanDefinitionNames) &#123;</span><br><span class="line">        System.out.println(beanDefinitionName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LifeCycleController lifeCycleController = applicationContext.getBean(LifeCycleController<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    lifeCycleController.say(<span class="string">"zhangsan"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭容器</span></span><br><span class="line">    applicationContext.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">lifeCycleController constructor...</span><br><span class="line">lifeCycleController ... init...</span><br><span class="line">container start up</span><br><span class="line">org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalRequiredAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalCommonAnnotationProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerFactory</span><br><span class="line">annotationConfig</span><br><span class="line">lifeCycleController</span><br><span class="line">hello zhangsan</span><br><span class="line">lifeCycleController ... detory...</span><br></pre></td></tr></table></figure>
<h4 id="5-1-2-示例：实现-InitializingBean-和-DisposableBean"><a href="#5-1-2-示例：实现-InitializingBean-和-DisposableBean" class="headerlink" title="5.1.2 示例：实现 InitializingBean 和 DisposableBean"></a>5.1.2 示例：实现 InitializingBean 和 DisposableBean</h4><p>Bean 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.DisposableBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LifeCycleController</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span>, <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LifeCycleController</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"lifeCycleController constructor..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"lifeCycleController ... detory..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"lifeCycleController ... init..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"hello "</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.wise.controller.LifeCycleController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LifeCycleController <span class="title">lifeCycleController</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LifeCycleController();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>单元测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lifeCycleTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(AnnotationConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"container start up"</span>);</span><br><span class="line"></span><br><span class="line">    String[] beanDefinitionNames = applicationContext.getBeanDefinitionNames();</span><br><span class="line">    <span class="keyword">for</span> (String beanDefinitionName : beanDefinitionNames) &#123;</span><br><span class="line">        System.out.println(beanDefinitionName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LifeCycleController lifeCycleController = applicationContext.getBean(LifeCycleController<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    lifeCycleController.say(<span class="string">"zhangsan"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭容器</span></span><br><span class="line">    applicationContext.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">lifeCycleController constructor...</span><br><span class="line">lifeCycleController ... init...</span><br><span class="line">container start up</span><br><span class="line">org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalRequiredAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalCommonAnnotationProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerFactory</span><br><span class="line">annotationConfig</span><br><span class="line">lifeCycleController</span><br><span class="line">hello zhangsan</span><br><span class="line">lifeCycleController ... detory...</span><br></pre></td></tr></table></figure>
<h4 id="5-1-3-示例：-PostConstruct-和-PreDestroy"><a href="#5-1-3-示例：-PostConstruct-和-PreDestroy" class="headerlink" title="5.1.3 示例：@PostConstruct 和 @PreDestroy"></a>5.1.3 示例：@PostConstruct 和 @PreDestroy</h4><p>Bean 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.PreDestroy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LifeCycleController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LifeCycleController</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"lifeCycleController constructor..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"lifeCycleController ... detory..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"lifeCycleController ... init..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"hello "</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.wise.controller.LifeCycleController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LifeCycleController <span class="title">lifeCycleController</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LifeCycleController();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>单元测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lifeCycleTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(AnnotationConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"container start up"</span>);</span><br><span class="line"></span><br><span class="line">    String[] beanDefinitionNames = applicationContext.getBeanDefinitionNames();</span><br><span class="line">    <span class="keyword">for</span> (String beanDefinitionName : beanDefinitionNames) &#123;</span><br><span class="line">        System.out.println(beanDefinitionName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LifeCycleController lifeCycleController = applicationContext.getBean(LifeCycleController<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    lifeCycleController.say(<span class="string">"zhangsan"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭容器</span></span><br><span class="line">    applicationContext.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">lifeCycleController constructor...</span><br><span class="line">lifeCycleController ... init...</span><br><span class="line">container start up</span><br><span class="line">org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalRequiredAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalCommonAnnotationProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerFactory</span><br><span class="line">annotationConfig</span><br><span class="line">lifeCycleController</span><br><span class="line">hello zhangsan</span><br><span class="line">lifeCycleController ... detory...</span><br></pre></td></tr></table></figure>
<h4 id="5-1-4-示例：实现-BeanPostProcessor-接口"><a href="#5-1-4-示例：实现-BeanPostProcessor-接口" class="headerlink" title="5.1.4 示例：实现 BeanPostProcessor 接口"></a>5.1.4 示例：实现 BeanPostProcessor 接口</h4><p>自定义 Bean 的后置处理器，官方示例：</p>
<p><code>ApplicationContextAwareProcessor</code>，</p>
<p><code>InitDestroyAnnotationBeanPostProcessor</code>，</p>
<p><code>AsyncAnnotationBeanPostProcessor</code>，</p>
<p><code>AutowiredAnnotationBeanPostProcessor</code></p>
<blockquote>
<p>TIPS：可以结合 <code>@order</code> 注解或 <code>PriorityOrdered</code> 接口控制 <code>BeanPostProcessor</code> 的执行顺序。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.BeanPostProcessor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"postProcessBeforeInitialization..."</span> + beanName + <span class="string">"===&gt;"</span> + bean);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// bean 可以经过包装后再返回</span></span><br><span class="line">		<span class="keyword">return</span> bean;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"postProcessAfterInitialization..."</span> + beanName + <span class="string">"===&gt;"</span> + bean);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// bean 可以经过包装后再返回</span></span><br><span class="line">		<span class="keyword">return</span> bean;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.wise.controller.LifeCycleController;</span><br><span class="line"><span class="keyword">import</span> com.wise.processor.CustomBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LifeCycleController <span class="title">lifeCycleController</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LifeCycleController();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CustomBeanPostProcessor <span class="title">customBeanPostProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CustomBeanPostProcessor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>单元测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lifeCycleTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(AnnotationConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"container start up"</span>);</span><br><span class="line"></span><br><span class="line">    String[] beanDefinitionNames = applicationContext.getBeanDefinitionNames();</span><br><span class="line">    <span class="keyword">for</span> (String beanDefinitionName : beanDefinitionNames) &#123;</span><br><span class="line">        System.out.println(beanDefinitionName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LifeCycleController lifeCycleController = applicationContext.getBean(LifeCycleController<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    lifeCycleController.say(<span class="string">"zhangsan"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭容器</span></span><br><span class="line">    applicationContext.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">postProcessBeforeInitialization...org.springframework.context.event.internalEventListenerProcessor===&gt;org.springframework.context.event.EventListenerMethodProcessor@<span class="number">62</span>bd765</span><br><span class="line">postProcessAfterInitialization...org.springframework.context.event.internalEventListenerProcessor===&gt;org.springframework.context.event.EventListenerMethodProcessor@<span class="number">62</span>bd765</span><br><span class="line">postProcessBeforeInitialization...org.springframework.context.event.internalEventListenerFactory===&gt;org.springframework.context.event.DefaultEventListenerFactory@<span class="number">78</span>a2da20</span><br><span class="line">postProcessAfterInitialization...org.springframework.context.event.internalEventListenerFactory===&gt;org.springframework.context.event.DefaultEventListenerFactory@<span class="number">78</span>a2da20</span><br><span class="line">lifeCycleController constructor...</span><br><span class="line">postProcessBeforeInitialization...lifeCycleController===&gt;com.wise.controller.LifeCycleController<span class="meta">@ba</span>8d91c</span><br><span class="line">lifeCycleController ... init...</span><br><span class="line">postProcessAfterInitialization...lifeCycleController===&gt;com.wise.controller.LifeCycleController<span class="meta">@ba</span>8d91c</span><br><span class="line">container start up</span><br><span class="line">org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalRequiredAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalCommonAnnotationProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerFactory</span><br><span class="line">annotationConfig</span><br><span class="line">lifeCycleController</span><br><span class="line">customBeanPostProcessor</span><br><span class="line">hello zhangsan</span><br><span class="line">lifeCycleController ... detory...</span><br></pre></td></tr></table></figure>
<h2 id="6-属性注入"><a href="#6-属性注入" class="headerlink" title="6 属性注入"></a>6 属性注入</h2><h3 id="6-1-Value"><a href="#6-1-Value" class="headerlink" title="6.1 @Value"></a>6.1 @Value</h3><p>@Value 参数允许的数据类型</p>
<ol>
<li>基本数值</li>
<li>SpEL：#{}</li>
<li>${}：取出配置文件 properties 中或环境变量中的值</li>
</ol>
<blockquote>
<p>TIPS：使用 <code>@PropertySource</code> 注解可以加载属性配置文件。</p>
</blockquote>
<p>获取环境变量示例：获取操作系统名称<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ConfigurableEnvironment environment = applicationContext.getEnvironment();</span><br><span class="line">String property = environment.getProperty(<span class="string">"os.name"</span>);</span><br><span class="line">System.out.println(property);</span><br></pre></td></tr></table></figure></p>
<h3 id="6-2-BeanPostProcessor-方式"><a href="#6-2-BeanPostProcessor-方式" class="headerlink" title="6.2 BeanPostProcessor 方式"></a>6.2 BeanPostProcessor 方式</h3><h3 id="6-3-Autowired"><a href="#6-3-Autowired" class="headerlink" title="6.3 @Autowired"></a>6.3 @Autowired</h3><p>执行逻辑</p>
<ol>
<li>默认优先按照类型去容器中找对应的组件，找到则赋值</li>
<li>若找到多个相同类型的组件，再将属性的名称作为组件的 id 到容器中查找</li>
<li><code>@Qualifier(&quot;id&quot;)</code>：使用 <code>@Qualifier</code> 指定需要装配的组件的 id，而不是使用属性名</li>
<li>自动装配默认一定要将属性赋值好，没有则会报错。可以使用 <code>@Autowired(required=false)</code> 避免报错</li>
<li><code>@Primary</code>：在自动装配的时，默认使用首选的 bean</li>
</ol>
<p>标注在如下位置都可以注入组件</p>
<ol>
<li>[标注在方法位置]：@Bean+方法参数；参数从容器中获取；默认不写 @Autowired 效果是一样的；都能自动装配</li>
<li>[标在构造器上]：若组件只有一个有参构造器，这个有参构造器的 @Autowired 可以省略，参数位置的组件还是可以自动从容器中获取</li>
<li>[标在形参上]：参数位置的组件还是可以自动从容器中获取</li>
</ol>
<h2 id="7-Aware-接口"><a href="#7-Aware-接口" class="headerlink" title="7 Aware 接口"></a>7 Aware 接口</h2><p>自定义组件实现 Aware 接口，在创建对象的时，会调用接口规定的方法注入相关组件。</p>
<blockquote>
<p>示例</p>
</blockquote>
<p>Aware 实现类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.BeanNameAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.EmbeddedValueResolverAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringValueResolver;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomAware</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span>, <span class="title">BeanNameAware</span>, <span class="title">EmbeddedValueResolverAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.applicationContext = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ApplicationContext <span class="title">getApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 本对象实例在容器里的 id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"bean name: "</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> resolver</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEmbeddedValueResolver</span><span class="params">(StringValueResolver resolver)</span> </span>&#123;</span><br><span class="line">        String resolveStringValue = resolver.resolveStringValue(<span class="string">"Hello $&#123;os.name&#125;, math cal result: #&#123;21*13&#125;"</span>);</span><br><span class="line">        System.out.println(<span class="string">"resolve result: "</span> + resolveStringValue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>配置类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(value = <span class="string">"com.wise"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>单元测试<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">awareTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(AnnotationConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    CustomAware customAware = applicationContext.getBean(CustomAware<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    ApplicationContext applicationContextTemp = customAware.getApplicationContext();</span><br><span class="line">    System.out.println(applicationContext == applicationContextTemp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>控制台输出<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bean name: customAware</span><br><span class="line">resolve result: Hello Windows <span class="number">7</span>, math cal result: <span class="number">273</span></span><br><span class="line"><span class="keyword">true</span></span><br></pre></td></tr></table></figure></p>
<h2 id="8-Profile"><a href="#8-Profile" class="headerlink" title="8 @Profile"></a>8 @Profile</h2><p>根据环境激活组件。</p>
<h2 id="9-AOP"><a href="#9-AOP" class="headerlink" title="9 AOP"></a>9 AOP</h2><p>通知类型</p>
<ol>
<li>前置通知(@Before)：在目标方法运行之前运行</li>
<li>后置通知(@After)：在目标方法运行结束之后运行（无论方法正常结束还是异常结束）</li>
<li>返回通知(@AfterReturning)：在目标方法正常返回之后运行</li>
<li>异常通知(@AfterThrowing)：在目标方法出现异常以后运行</li>
<li>环绕通知(@Around)：动态代理，手动推进目标方法运行（joinPoint.procced()）</li>
</ol>
<h3 id="9-1-原理"><a href="#9-1-原理" class="headerlink" title="9.1 原理"></a>9.1 原理</h3><p>AOP 实现原理：链式调用。</p>
<p>创建和注册 AnnotationAwareAspectJAutoProxyCreator 的过程<br>1）、传入配置类，创建ioc容器<br>2）、注册配置类，调用refresh（）刷新容器；<br>3）、registerBeanPostProcessors(beanFactory);注册bean的后置处理器来方便拦截bean的创建；<br>– 3.1）、先获取ioc容器已经定义了的需要创建对象的所有BeanPostProcessor<br>– 3.2）、给容器中加别的BeanPostProcessor<br>– 3.3）、优先注册实现了PriorityOrdered接口的BeanPostProcessor；<br>– 3.4）、再给容器中注册实现了Ordered接口的BeanPostProcessor；<br>– 3.5）、注册没实现优先级接口的BeanPostProcessor；<br>– 3.6）、注册BeanPostProcessor，实际上就是创建BeanPostProcessor对象，保存在容器中；<br>—- 3.6.1）、创建internalAutoProxyCreator的BeanPostProcessor【AnnotationAwareAspectJAutoProxyCreator】的bean实例<br>—- 3.6.2）、populateBean；给bean的各种属性赋值<br>—- 3.6.3）、initializeBean：初始化bean；<br>—— 3.6.3.1）、invokeAwareMethods()：处理Aware接口的方法回调<br>—— 3.6.3.2）、applyBeanPostProcessorsBeforeInitialization()：应用后置处理器的postProcessBeforeInitialization（）<br>—— 3.6.3.3）、invokeInitMethods()；执行自定义的初始化方法<br>—— 3.6.3.4）、applyBeanPostProcessorsAfterInitialization()；执行后置处理器的postProcessAfterInitialization（）；<br>—- 3.6.4）、BeanPostProcessor(AnnotationAwareAspectJAutoProxyCreator)创建成功；–&gt; aspectJAdvisorsBuilder<br>– 3.7）、把BeanPostProcessor注册到BeanFactory中；beanFactory.addBeanPostProcessor(postProcessor);</p>
<h3 id="9-2-示例"><a href="#9-2-示例" class="headerlink" title="9.2 示例"></a>9.2 示例</h3><blockquote>
<p>处理日志</p>
</blockquote>
<p>业务类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 数学运算器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MathCalculator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">div</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"MathCalculator...div..."</span>);</span><br><span class="line">		<span class="keyword">return</span> i / j;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>日志类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用切面处理日志</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogAspects</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 抽取公共的切入点表达式</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Pointcut</span>(<span class="string">"execution(public int com.wise.aop.MathCalculator.*(..))"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pointCut</span><span class="params">()</span></span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@Before</span>在目标方法之前切入；切入点表达式（指定在哪个方法切入）</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Before</span>(<span class="string">"pointCut()"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logStart</span><span class="params">(JoinPoint joinPoint)</span></span>&#123;</span><br><span class="line">		Object[] args = joinPoint.getArgs();</span><br><span class="line">		System.out.println(joinPoint.getSignature().getName() + <span class="string">"运行。。。@Before:参数列表是：&#123;"</span> + Arrays.asList(args) + <span class="string">"&#125;"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@After</span>(<span class="string">"com.wise.aop.LogAspects.pointCut()"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logEnd</span><span class="params">(JoinPoint joinPoint)</span></span>&#123;</span><br><span class="line">		System.out.println(joinPoint.getSignature().getName() + <span class="string">"结束。。。@After"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * JoinPoint 一定要出现在参数表的第一位</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> joinPoint</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> result</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@AfterReturning</span>(value=<span class="string">"pointCut()"</span>,returning=<span class="string">"result"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logReturn</span><span class="params">(JoinPoint joinPoint, Object result)</span></span>&#123;</span><br><span class="line">		System.out.println(joinPoint.getSignature().getName() + <span class="string">"正常返回。。。@AfterReturning:运行结果：&#123;"</span> + result + <span class="string">"&#125;"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@AfterThrowing</span>(value=<span class="string">"pointCut()"</span>, throwing=<span class="string">"exception"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logException</span><span class="params">(JoinPoint joinPoint, Exception exception)</span></span>&#123;</span><br><span class="line">		System.out.println(joinPoint.getSignature().getName() + <span class="string">"异常。。。异常信息：&#123;"</span> + exception + <span class="string">"&#125;"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.wise.aop.LogAspects;</span><br><span class="line"><span class="keyword">import</span> com.wise.aop.MathCalculator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.EnableAspectJAutoProxy;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 业务逻辑类加入容器中</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MathCalculator <span class="title">calculator</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MathCalculator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 切面类加入到容器中</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LogAspects <span class="title">logAspects</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LogAspects();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>单元测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">aopTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(AnnotationConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    MathCalculator mathCalculator = applicationContext.getBean(MathCalculator<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    mathCalculator.div(<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">div运行。。。<span class="meta">@Before</span>:参数列表是：&#123;[<span class="number">1</span>, <span class="number">0</span>]&#125;</span><br><span class="line">MathCalculator...div...</span><br><span class="line">div结束。。。<span class="meta">@After</span></span><br><span class="line">div异常。。。异常信息：&#123;java.lang.ArithmeticException: / by zero&#125;</span><br></pre></td></tr></table></figure>
<h2 id="10-Transaction"><a href="#10-Transaction" class="headerlink" title="10 Transaction"></a>10 Transaction</h2><blockquote>
<p>示例：声明式事务</p>
</blockquote>
<p>业务类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Transactional</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertUser</span><span class="params">()</span></span>&#123;</span><br><span class="line">		userDao.insert();</span><br><span class="line">		System.out.println(<span class="string">"插入完成..."</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 将会报错</span></span><br><span class="line">		<span class="keyword">int</span> i = <span class="number">10</span> / <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>持久层类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">()</span></span>&#123;</span><br><span class="line">		String sql = <span class="string">"INSERT INTO `tbl_user`(username,age) VALUES(?,?)"</span>;</span><br><span class="line">		String username = UUID.randomUUID().toString().substring(<span class="number">0</span>, <span class="number">5</span>);</span><br><span class="line">		jdbcTemplate.update(sql, username, <span class="number">19</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.ComboPooledDataSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.DataSourceTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 声明式事务：</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 环境搭建：</span></span><br><span class="line"><span class="comment"> * 1、导入相关依赖</span></span><br><span class="line"><span class="comment"> * 		数据源、数据库驱动、Spring-jdbc模块</span></span><br><span class="line"><span class="comment"> * 2、配置数据源、JdbcTemplate（Spring提供的简化数据库操作的工具）操作数据</span></span><br><span class="line"><span class="comment"> * 3、给方法上标注 <span class="doctag">@Transactional</span> 表示当前方法是一个事务方法；</span></span><br><span class="line"><span class="comment"> * 4、 <span class="doctag">@EnableTransactionManagement</span> 开启基于注解的事务管理功能；</span></span><br><span class="line"><span class="comment"> * 		<span class="doctag">@EnableXXX</span></span></span><br><span class="line"><span class="comment"> * 5、配置事务管理器来控制事务;</span></span><br><span class="line"><span class="comment"> * 		<span class="doctag">@Bean</span></span></span><br><span class="line"><span class="comment"> * 		public PlatformTransactionManager transactionManager()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"com.wise.tx"</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TxConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 数据源</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">		ComboPooledDataSource dataSource = <span class="keyword">new</span> ComboPooledDataSource();</span><br><span class="line">		dataSource.setUser(<span class="string">"root"</span>);</span><br><span class="line">		dataSource.setPassword(<span class="string">"123456"</span>);</span><br><span class="line">		dataSource.setDriverClass(<span class="string">"com.mysql.jdbc.Driver"</span>);</span><br><span class="line">		dataSource.setJdbcUrl(<span class="string">"jdbc:mysql://localhost:3306/mysql_test"</span>);</span><br><span class="line">		<span class="keyword">return</span> dataSource;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate</span><span class="params">(DataSource dataSource)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">		JdbcTemplate jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);</span><br><span class="line">		<span class="keyword">return</span> jdbcTemplate;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 注册事务管理器在容器中</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>单元测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TxTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(TxConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        UserService userService = applicationContext.getBean(UserService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        userService.insertUser();</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="11-Extend"><a href="#11-Extend" class="headerlink" title="11 Extend"></a>11 Extend</h2><h3 id="11-1-BeanFactoryPostProcessor"><a href="#11-1-BeanFactoryPostProcessor" class="headerlink" title="11.1 BeanFactoryPostProcessor"></a>11.1 BeanFactoryPostProcessor</h3><p>在 <code>BeanFactory</code> 标准初始化之后调用，以定制和修改 <code>BeanFactory</code> 的内容。所有的 <code>Bean</code> 定义已经保存加载到 <code>BeanFactory</code>，但是 <code>Bean</code> 的实例还未创建</p>
<blockquote>
<p>示例</p>
</blockquote>
<p>配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"com.wise.ext"</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExtConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>业务类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExtService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExtService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"ExtService...constructor"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">extFunction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"ExtService...extFunction..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>优先级较高的 BeanFactoryPostProcessor 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.BeanFactoryPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.ConfigurableListableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.PriorityOrdered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 优先级较高的 BeanFactoryPostProcessor</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PriorityOrderedBeanFactoryPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanFactoryPostProcessor</span>, <span class="title">PriorityOrdered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在 BeanFactory 标准初始化之后调用，以定制和修改 BeanFactory 的内容。</span></span><br><span class="line"><span class="comment">     * 所有的bean定义已经保存加载到 beanFactory，但是bean的实例还未创建</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanFactory</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> BeansException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"PriorityOrderedBeanFactoryPostProcessor...postProcessBeanFactory..."</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>优先级比实现 PriorityOrdered 接口的 BeanFactoryPostProcessor 接口略低的类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.BeanFactoryPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.ConfigurableListableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 优先级比实现 PriorityOrdered 接口的 BeanFactoryPostProcessor 接口略低</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderedBeanFactoryPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanFactoryPostProcessor</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在 BeanFactory 标准初始化之后调用，以定制和修改 BeanFactory 的内容。</span></span><br><span class="line"><span class="comment">     * 所有的bean定义已经保存加载到 beanFactory，但是bean的实例还未创建</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanFactory</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> BeansException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"OrderedBeanFactoryPostProcessor...postProcessBeanFactory..."</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>无优先级 BeanFactoryPostProcessor 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.BeanFactoryPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.ConfigurableListableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomBeanFactoryPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanFactoryPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在 BeanFactory 标准初始化之后调用，以定制和修改 BeanFactory 的内容。</span></span><br><span class="line"><span class="comment">     * 所有的bean定义已经保存加载到 beanFactory，但是bean的实例还未创建</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanFactory</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> BeansException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"CustomBeanFactoryPostProcessor...postProcessBeanFactory...start..."</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 获取已定义的 Bean 的数量</span></span><br><span class="line">		<span class="keyword">int</span> count = beanFactory.getBeanDefinitionCount();</span><br><span class="line">        System.out.println(<span class="string">"当前BeanFactory中有"</span> + count + <span class="string">"个Bean"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取已定义的 Bean 的名称</span></span><br><span class="line">        String[] names = beanFactory.getBeanDefinitionNames();</span><br><span class="line">		<span class="keyword">for</span> (String name : names) &#123;</span><br><span class="line">			System.out.println(name);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		System.out.println(<span class="string">"CustomBeanFactoryPostProcessor...postProcessBeanFactory...end..."</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>单元测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExtTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beanFactoryPostProcessorTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(ExtConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PriorityOrderedBeanFactoryPostProcessor...postProcessBeanFactory...</span><br><span class="line">OrderedBeanFactoryPostProcessor...postProcessBeanFactory...</span><br><span class="line">CustomBeanFactoryPostProcessor...postProcessBeanFactory...start...</span><br><span class="line">当前BeanFactory中有<span class="number">11</span>个Bean</span><br><span class="line">org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalRequiredAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalCommonAnnotationProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerFactory</span><br><span class="line">extConfig</span><br><span class="line">customBeanFactoryPostProcessor</span><br><span class="line">extService</span><br><span class="line">orderedBeanFactoryPostProcessor</span><br><span class="line">priorityOrderedBeanFactoryPostProcessor</span><br><span class="line">CustomBeanFactoryPostProcessor...postProcessBeanFactory...end...</span><br><span class="line">ExtService...constructor</span><br></pre></td></tr></table></figure>
<h3 id="11-2-BeanDefinitionRegistryPostProcessor"><a href="#11-2-BeanDefinitionRegistryPostProcessor" class="headerlink" title="11.2 BeanDefinitionRegistryPostProcessor"></a>11.2 BeanDefinitionRegistryPostProcessor</h3><p>在所有 Bean 定义信息要被加载前执行。先于 BeanFactoryPostProcessor 执行。可用于注册第三方组件。</p>
<blockquote>
<p>示例：类似 11.1 节示例，但添加 BeanDefinitionRegistryPostProcessor 实现类</p>
</blockquote>
<p>BeanDefinitionRegistryPostProcessor 实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.ConfigurableListableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.AbstractBeanDefinition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.BeanDefinitionBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.BeanDefinitionRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.BeanDefinitionRegistryPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在所有 Bean 定义信息要被加载前执行。先于 BeanFactoryPostProcessor 执行</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomBeanDefinitionRegistryPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanDefinitionRegistryPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * BeanDefinitionRegistry：Bean定义信息的保存中心，</span></span><br><span class="line"><span class="comment">	 * 以后 BeanFactory 就是按照 BeanDefinitionRegistry 里面保存的每一个 Bean 定义信息创建 Bean 的实例</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"CustomBeanDefinitionRegistryPostProcessor...postProcessBeanDefinitionRegistry...bean 的数量："</span> + registry.getBeanDefinitionCount());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 注册 Bean</span></span><br><span class="line">		AbstractBeanDefinition beanDefinition = BeanDefinitionBuilder.rootBeanDefinition(ExtService<span class="class">.<span class="keyword">class</span>).<span class="title">getBeanDefinition</span>()</span>;</span><br><span class="line">		registry.registerBeanDefinition(<span class="string">"ThirdPartyExtService"</span>, beanDefinition);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"CustomBeanDefinitionRegistryPostProcessor...postProcessBeanFactory...bean 的数量："</span> + beanFactory.getBeanDefinitionCount());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>单元测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TxTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(TxConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        UserService userService = applicationContext.getBean(UserService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        userService.insertUser();</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">CustomBeanDefinitionRegistryPostProcessor...postProcessBeanDefinitionRegistry...bean 的数量：<span class="number">12</span></span><br><span class="line">CustomBeanDefinitionRegistryPostProcessor...postProcessBeanFactory...bean 的数量：<span class="number">13</span></span><br><span class="line">PriorityOrderedBeanFactoryPostProcessor...postProcessBeanFactory...</span><br><span class="line">OrderedBeanFactoryPostProcessor...postProcessBeanFactory...</span><br><span class="line">CustomBeanFactoryPostProcessor...postProcessBeanFactory...start...</span><br><span class="line">当前BeanFactory中有<span class="number">13</span>个Bean</span><br><span class="line">org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalRequiredAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalCommonAnnotationProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerFactory</span><br><span class="line">extConfig</span><br><span class="line">customBeanDefinitionRegistryPostProcessor</span><br><span class="line">customBeanFactoryPostProcessor</span><br><span class="line">extService</span><br><span class="line">orderedBeanFactoryPostProcessor</span><br><span class="line">priorityOrderedBeanFactoryPostProcessor</span><br><span class="line">ThirdPartyExtService</span><br><span class="line">CustomBeanFactoryPostProcessor...postProcessBeanFactory...end...</span><br><span class="line">ExtService...constructor</span><br><span class="line">ExtService...constructor</span><br></pre></td></tr></table></figure>
<h3 id="11-3-ApplicationListener"><a href="#11-3-ApplicationListener" class="headerlink" title="11.3 ApplicationListener"></a>11.3 ApplicationListener</h3><p>监听容器中发布的事件。</p>
<p>步骤</p>
<ol>
<li>定义事件</li>
<li>定义监听器（ApplicationListener 的实现类）用于监听某个事件（ApplicationEvent 及其子类）</li>
<li>把监听器加入到容器</li>
<li>发布事件</li>
</ol>
<h4 id="11-3-1-示例：同步发送邮件"><a href="#11-3-1-示例：同步发送邮件" class="headerlink" title="11.3.1 示例：同步发送邮件"></a>11.3.1 示例：同步发送邮件</h4><p>定义事件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.event.ApplicationContextEvent;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 邮件发送事件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MailSendEvent</span> <span class="keyword">extends</span> <span class="title">ApplicationContextEvent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String to;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String content;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MailSendEvent</span><span class="params">(ApplicationContext source, String to, String content)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(source);</span><br><span class="line">		<span class="keyword">this</span>.to = to;</span><br><span class="line">		<span class="keyword">this</span>.content = content;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getTo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> to;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getContent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> content;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义监听器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.event.EventListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 邮件监听器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MailSendListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@EventListener</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMailSendEvent</span><span class="params">(MailSendEvent event)</span> </span>&#123;</span><br><span class="line">			System.out.println(<span class="string">"当前线程："</span> + Thread.currentThread() + <span class="string">"，MailSendListener：向"</span> + event.getTo() + <span class="string">"发送："</span> + event.getContent());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义发送器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 邮件发送器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MailSender</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ApplicationContext ctx ;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext ctx)</span>  </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.ctx = ctx;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMail</span><span class="params">(String to, String content)</span></span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"当前线程："</span> + Thread.currentThread() + <span class="string">"，MailSender：模拟发送邮件..."</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 发布事件</span></span><br><span class="line">		MailSendEvent mse = <span class="keyword">new</span> MailSendEvent(<span class="keyword">this</span>.ctx, to, content);</span><br><span class="line">		ctx.publishEvent(mse);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"com.wise.ext"</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExtConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>单元测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.wise.ext.listener.MailSender;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExtTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listenerTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(ExtConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        MailSender mailSender = applicationContext.getBean(MailSender<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        mailSender.sendMail(<span class="string">"xxx@qq.com"</span>, <span class="string">"Hello xxx."</span>);</span><br><span class="line"></span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">当前线程：Thread[main,<span class="number">5</span>,main]，MailSender：模拟发送邮件...</span><br><span class="line">当前线程：Thread[main,<span class="number">5</span>,main]，MailSendListener：向xxx<span class="meta">@qq</span>.com发送：Hello xxx.</span><br></pre></td></tr></table></figure>
<h4 id="11-3-2-示例：异步发送邮件"><a href="#11-3-2-示例：异步发送邮件" class="headerlink" title="11.3.2 示例：异步发送邮件"></a>11.3.2 示例：异步发送邮件</h4><p>类似 11.3.1 节，但配置类自定义事件广播器。</p>
<p>定义监听器，使用懒加载，节省资源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Lazy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.event.EventListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 邮件监听器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Lazy</span> <span class="comment">// 懒加载</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MailSendListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MailSendListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"MailSendListener...constructor"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@EventListener</span></span><br><span class="line"><span class="comment">//	@EventListener(classes = MailSendEvent.class)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMailSendEvent</span><span class="params">(MailSendEvent event)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"当前线程："</span> + Thread.currentThread() + <span class="string">"，MailSendListener：向"</span> + event.getTo() + <span class="string">"发送："</span> + event.getContent());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.event.SimpleApplicationEventMulticaster;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"com.wise.ext"</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExtConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 任务线程池</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Executor <span class="title">taskExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadPoolTaskExecutor taskExecutor = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        taskExecutor.setCorePoolSize(<span class="number">2</span>); <span class="comment">// 核心线程大小</span></span><br><span class="line">        taskExecutor.setMaxPoolSize(<span class="number">8</span>); <span class="comment">// 最大线程大小</span></span><br><span class="line">        taskExecutor.setQueueCapacity(<span class="number">100</span>); <span class="comment">// 等待队列长度</span></span><br><span class="line">        taskExecutor.setKeepAliveSeconds(<span class="number">60</span>); <span class="comment">// 空闲时保持60秒就销毁</span></span><br><span class="line">        taskExecutor.setThreadNamePrefix(<span class="string">"taskExecutor-"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// rejection-policy：当pool已经达到max size的时候，如何处理新任务</span></span><br><span class="line">        <span class="comment">// CALLER_RUNS：不在新线程中执行任务，而是由调用者所在的线程来执行</span></span><br><span class="line">        taskExecutor.setRejectedExecutionHandler(<span class="keyword">new</span> ThreadPoolExecutor.CallerRunsPolicy());</span><br><span class="line">        taskExecutor.initialize();</span><br><span class="line">        <span class="keyword">return</span> taskExecutor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 覆盖默认事件广播器，设置任务线程池</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> taskExecutor</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SimpleApplicationEventMulticaster <span class="title">applicationEventMulticaster</span><span class="params">(Executor taskExecutor)</span> </span>&#123;</span><br><span class="line">        SimpleApplicationEventMulticaster applicationEventMulticaster = <span class="keyword">new</span> SimpleApplicationEventMulticaster();</span><br><span class="line">        applicationEventMulticaster.setTaskExecutor(taskExecutor);</span><br><span class="line">        <span class="keyword">return</span> applicationEventMulticaster;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>单元测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Lazy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.event.EventListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 邮件监听器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Lazy</span> <span class="comment">// 懒加载</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MailSendListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MailSendListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"MailSendListener...constructor"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@EventListener</span></span><br><span class="line"><span class="comment">//	@EventListener(classes = MailSendEvent.class)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMailSendEvent</span><span class="params">(MailSendEvent event)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"当前线程："</span> + Thread.currentThread() + <span class="string">"，MailSendListener：向"</span> + event.getTo() + <span class="string">"发送："</span> + event.getContent());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">容器已启动</span><br><span class="line">当前线程：Thread[main,<span class="number">5</span>,main]，MailSender：模拟发送邮件...</span><br><span class="line">MailSendListener...constructor</span><br><span class="line">当前线程：Thread[taskExecutor-<span class="number">1</span>,<span class="number">5</span>,main]，MailSendListener：向xxx<span class="meta">@qq</span>.com发送：Hello xxx.</span><br></pre></td></tr></table></figure>
<h2 id="12-Start-up-process"><a href="#12-Start-up-process" class="headerlink" title="12 Start-up process"></a>12 Start-up process</h2><p>Spring 容器的 <code>refresh()</code>。</p>
<h3 id="12-1-prepareRefresh-刷新前的预处理"><a href="#12-1-prepareRefresh-刷新前的预处理" class="headerlink" title="12.1 prepareRefresh() 刷新前的预处理"></a>12.1 prepareRefresh() 刷新前的预处理</h3><ol>
<li><code>initPropertySources()</code> 初始化一些属性设置；子类自定义个性化的属性设置方法</li>
<li><code>getEnvironment().validateRequiredProperties()</code> 检验属性的合法等</li>
<li><code>earlyApplicationEvents = new LinkedHashSet&lt;ApplicationEvent&gt;()</code> 保存容器中的一些早期的事件</li>
</ol>
<h3 id="12-2-obtainFreshBeanFactory-获取-BeanFactory"><a href="#12-2-obtainFreshBeanFactory-获取-BeanFactory" class="headerlink" title="12.2 obtainFreshBeanFactory() 获取 BeanFactory"></a>12.2 obtainFreshBeanFactory() 获取 BeanFactory</h3><ol>
<li><code>refreshBeanFactory()</code> 刷新/创建 BeanFactory：创建 <code>this.beanFactory = new DefaultListableBeanFactory()</code> 并设置 id</li>
<li><code>getBeanFactory()</code> 返回刚才 GenericApplicationContext 创建的 BeanFactory 对象</li>
<li>将创建的 DefaultListableBeanFactory 返回</li>
</ol>
<h3 id="12-3-prepareBeanFactory-beanFactory-BeanFactory-的预准备工作"><a href="#12-3-prepareBeanFactory-beanFactory-BeanFactory-的预准备工作" class="headerlink" title="12.3 prepareBeanFactory(beanFactory) BeanFactory 的预准备工作"></a>12.3 prepareBeanFactory(beanFactory) BeanFactory 的预准备工作</h3><ol>
<li>设置 BeanFactory 的类加载器、支持表达式解析器等</li>
<li>添加部分 BeanPostProcessor，如：ApplicationContextAwareProcessor</li>
<li>设置忽略的自动装配的接口 EnvironmentAware、EmbeddedValueResolverAware 等</li>
<li>注册可以解析的自动装配。可以直接在任何组件中自动注入：BeanFactory、ResourceLoader、ApplicationEventPublisher、ApplicationContext</li>
<li>添加 BeanPostProcessor【ApplicationListenerDetector】</li>
<li>添加编译时的 AspectJ</li>
<li>给 BeanFactory 中注册一些能用的组件，如：environment【ConfigurableEnvironment】、systemProperties【Map&lt;String, Object&gt;】、systemEnvironment【Map&lt;String, Object&gt;】</li>
</ol>
<h3 id="12-4-postProcessBeanFactory-beanFactory-BeanFactory-准备工作后的后置处理"><a href="#12-4-postProcessBeanFactory-beanFactory-BeanFactory-准备工作后的后置处理" class="headerlink" title="12.4 postProcessBeanFactory(beanFactory) BeanFactory 准备工作后的后置处理"></a>12.4 postProcessBeanFactory(beanFactory) BeanFactory 准备工作后的后置处理</h3><p>子类通过重写这个方法以在 BeanFactory 创建并预准备完成以后做进一步的设置。</p>
<h3 id="12-5-invokeBeanFactoryPostProcessors-beanFactory-执行-BeanFactoryPostProcessor-方法"><a href="#12-5-invokeBeanFactoryPostProcessors-beanFactory-执行-BeanFactoryPostProcessor-方法" class="headerlink" title="12.5 invokeBeanFactoryPostProcessors(beanFactory) 执行 BeanFactoryPostProcessor 方法"></a>12.5 invokeBeanFactoryPostProcessors(beanFactory) 执行 BeanFactoryPostProcessor 方法</h3><p>BeanFactoryPostProcessor：BeanFactory 的后置处理器。在 BeanFactory 标准初始化之后执行。两个接口：BeanFactoryPostProcessor、BeanDefinitionRegistryPostProcessor</p>
<p>先执行 BeanDefinitionRegistryPostProcessor 的 postProcessBeanDefinitionRegistry 方法</p>
<ol>
<li>获取所有的 BeanDefinitionRegistryPostProcessor</li>
<li>先执行实现了 PriorityOrdered 优先级接口的 BeanDefinitionRegistryPostProcessor、postProcessor.postProcessBeanDefinitionRegistry(registry)</li>
<li>再执行实现了 Ordered 顺序接口的 BeanDefinitionRegistryPostProcessor、postProcessor.postProcessBeanDefinitionRegistry(registry)</li>
<li>最后执行没有实现任何优先级或者是顺序接口的 BeanDefinitionRegistryPostProcessors、postProcessor.postProcessBeanDefinitionRegistry(registry)</li>
</ol>
<p>再执行 BeanFactoryPostProcessor 的 postProcessBeanFactory 方法</p>
<ol>
<li>获取所有的 BeanFactoryPostProcessor</li>
<li>先执行实现了 PriorityOrdered 优先级接口的 BeanFactoryPostProcessor、postProcessor.postProcessBeanFactory()</li>
<li>再执行实现了 Ordered 顺序接口的 BeanFactoryPostProcessor、postProcessor.postProcessBeanFactory()</li>
<li>最后执行没有实现任何优先级或者是顺序接口的 BeanFactoryPostProcessor、postProcessor.postProcessBeanFactory()</li>
</ol>
<h3 id="12-6-registerBeanPostProcessors-beanFactory-注册-BeanPostProcessor（Bean-的后置处理器）"><a href="#12-6-registerBeanPostProcessors-beanFactory-注册-BeanPostProcessor（Bean-的后置处理器）" class="headerlink" title="12.6 registerBeanPostProcessors(beanFactory) 注册 BeanPostProcessor（Bean 的后置处理器）"></a>12.6 registerBeanPostProcessors(beanFactory) 注册 BeanPostProcessor（Bean 的后置处理器）</h3><p>不同接口类型的 BeanPostProcessor，在 Bean 创建前后的执行时机是不一样的。如：BeanPostProcessor、DestructionAwareBeanPostProcessor、InstantiationAwareBeanPostProcessor、SmartInstantiationAwareBeanPostProcessor、MergedBeanDefinitionPostProcessor</p>
<ol>
<li>获取所有的 BeanPostProcessor 后置处理器默认都可以通过 PriorityOrdered、Ordered 接口区分优先级</li>
<li>先注册 PriorityOrdered 优先级接口的 BeanPostProcessor</li>
<li>再注册 Ordered 接口的 BeanPostProcessor</li>
<li>最后注册没有实现任何优先级接口的 BeanPostProcessor</li>
<li>最终注册 MergedBeanDefinitionPostProcessor</li>
<li>注册 ApplicationListenerDetector 用于在 Bean 创建完成后检查是否是 ApplicationListener，若是则执行 <code>applicationContext.addApplicationListener((ApplicationListener&lt;?&gt;) bean)</code></li>
</ol>
<h3 id="12-7-initMessageSource-初始化-MessageSource-组件（做国际化功能；消息绑定，消息解析）"><a href="#12-7-initMessageSource-初始化-MessageSource-组件（做国际化功能；消息绑定，消息解析）" class="headerlink" title="12.7 initMessageSource() 初始化 MessageSource 组件（做国际化功能；消息绑定，消息解析）"></a>12.7 initMessageSource() 初始化 MessageSource 组件（做国际化功能；消息绑定，消息解析）</h3><ol>
<li>获取 BeanFactory</li>
<li>检查容器中是否有 id 为 messageSource 且类型是 MessageSource 的组件，若有则赋值给 messageSource，反之则创建一个 DelegatingMessageSource</li>
<li>将创建后的 MessageSource 注册在容器中，以后获取国际化配置文件的值时，可以自动注入 MessageSource</li>
</ol>
<h3 id="12-8-initApplicationEventMulticaster-初始化事件派发器"><a href="#12-8-initApplicationEventMulticaster-初始化事件派发器" class="headerlink" title="12.8 initApplicationEventMulticaster() 初始化事件派发器"></a>12.8 initApplicationEventMulticaster() 初始化事件派发器</h3><ol>
<li>获取 BeanFactory</li>
<li>从 BeanFactory 中获取 applicationEventMulticaster 的 ApplicationEventMulticaster</li>
<li>若上一步没有配置，则创建 SimpleApplicationEventMulticaster 并将其添加到 BeanFactory 中，以后其他组件可以直接自动注入</li>
</ol>
<h3 id="12-9-onRefresh-留给子容器（子类）重写"><a href="#12-9-onRefresh-留给子容器（子类）重写" class="headerlink" title="12.9 onRefresh() 留给子容器（子类）重写"></a>12.9 onRefresh() 留给子容器（子类）重写</h3><p>子类若重写这个方法，在容器刷新的时候可以自定义逻辑。</p>
<h3 id="12-10-registerListeners-注册监听器"><a href="#12-10-registerListeners-注册监听器" class="headerlink" title="12.10 registerListeners() 注册监听器"></a>12.10 registerListeners() 注册监听器</h3><ol>
<li>从容器中获取所有的 ApplicationListener</li>
<li>将每个监听器添加到事件派发器中</li>
<li>派发之前步骤产生的事件</li>
</ol>
<h3 id="12-11-finishBeanFactoryInitialization-beanFactory-初始化所有剩下的单实例-Bean"><a href="#12-11-finishBeanFactoryInitialization-beanFactory-初始化所有剩下的单实例-Bean" class="headerlink" title="12.11 finishBeanFactoryInitialization(beanFactory) 初始化所有剩下的单实例 Bean"></a>12.11 finishBeanFactoryInitialization(beanFactory) 初始化所有剩下的单实例 Bean</h3><h3 id="12-12-finishRefresh-完成-BeanFactory-的初始化创建工作"><a href="#12-12-finishRefresh-完成-BeanFactory-的初始化创建工作" class="headerlink" title="12.12 finishRefresh() 完成 BeanFactory 的初始化创建工作"></a>12.12 finishRefresh() 完成 BeanFactory 的初始化创建工作</h3><p>IOC 容器就此创建完成。</p>
<ol>
<li><code>initLifecycleProcessor();</code> 初始化和生命周期有关的后置处理器，LifecycleProcessor 默认从容器中找是否有 lifecycleProcessor 的组件（LifecycleProcessor）。若没有则 <code>new DefaultLifecycleProcessor();</code> 并加入到容器</li>
<li><code>getLifecycleProcessor().onRefresh();</code> 获取前面定义的生命周期处理器（BeanFactory），回调 onRefresh() 方法</li>
<li><code>publishEvent(new ContextRefreshedEvent(this));</code> 发布容器刷新完成事件</li>
<li><code>liveBeansView.registerApplicationContext(this);</code></li>
</ol>
<h2 id="13-核心类"><a href="#13-核心类" class="headerlink" title="13 核心类"></a>13 核心类</h2><table>
<thead>
<tr>
<th>核心类</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>AliasRegistry</td>
<td>定义对 alias 的 CRUD 操作</td>
</tr>
<tr>
<td>SimpleAliasRegistry</td>
<td>主要使用 map 作为 alias 的缓存，并对接口 AliasRegistry 进行实现</td>
</tr>
<tr>
<td>SingletonBeanRegistry</td>
<td>定义对单例的注册及获取</td>
</tr>
<tr>
<td>BeanFactory</td>
<td>定义获取 bean 及 bean 的各种属性</td>
</tr>
<tr>
<td>DefaultSingletonBeanRegistry</td>
<td>对接口 SingletonBeanRegistry 各函数的实现</td>
</tr>
<tr>
<td>HierarchicalBeanFactory</td>
<td>继承 BeanFactory，在 BeanFactory 定义的功能基础上增加对 parentFactory 的支持</td>
</tr>
<tr>
<td>BeanDefinitionRegistry</td>
<td>定义对 BeanDefinition 的各种增删改操作</td>
</tr>
<tr>
<td>FactoryBeanRegistrySupport</td>
<td>在 DefaultSingletonBeanRegistry 基础上增加对 FactoryBean 的特殊功能</td>
</tr>
<tr>
<td>ConfigurableBeanFactory</td>
<td>提供配置 Factory 的各种方法</td>
</tr>
<tr>
<td>ListableBeanFactory</td>
<td>根据各种条件获取 bean 的配置清单</td>
</tr>
<tr>
<td>AbstractBeanFactory</td>
<td>综合 FactoryBeanRegistrySupport 和 ConfigurableBeanFactory 的功能</td>
</tr>
<tr>
<td>AutowireCapableBeanFactory</td>
<td>提供创建 bean、自动注入、初始化以及应用 bean 的后处理器</td>
</tr>
<tr>
<td>AbstractAutowireCapableBeanFactory</td>
<td>综合 AbastractBeanFactory 并实现 AutowireCapableBeanFactory</td>
</tr>
<tr>
<td>ConfigurableListableBeanFactory</td>
<td>BeanFactory 配置清单</td>
</tr>
<tr>
<td>DefaultListableBeanFactory</td>
<td>主要对 bean 注册的后处理</td>
</tr>
<tr>
<td>ResourceLoader</td>
<td>定义资源加载器，主要应用于根据给定的资源文件地址返回对应的 Resource</td>
</tr>
<tr>
<td>BeanDefinitionReader</td>
<td>主要定义资源文件读取并转换为 BeanDefinition 的各个功能</td>
</tr>
<tr>
<td>EnvironmentCapable</td>
<td>定义获取 Environment 方法</td>
</tr>
<tr>
<td>DocumentLoader</td>
<td>定义从资源文件加载到转换为 Document 的功能</td>
</tr>
<tr>
<td>AbstractBeanDefinitionReader</td>
<td>对 EnvironmentCapable、BeanDefinitionReader 类定义的功能进行实现</td>
</tr>
<tr>
<td>BeanDefinitionDocumentReader</td>
<td>定义读取 Document 并注册 BeanDefinition 功能</td>
</tr>
<tr>
<td>BeanDefinitionParserDelegate</td>
<td>定义解析 Element 的各种方法</td>
</tr>
<tr>
<td>BeanDefinition</td>
<td>承载 bean 定义的接口，有三种实现，RootBeanDefinition、ChildBeanDefinition 和 GenericBeanDefinition</td>
</tr>
</tbody>
</table>

    </div>
    
    <div class="post-footer">
        <div class="col-sm-10">
            <div>
                <b>本文链接</b>：<a href="/2019/07/16/Spring源码详读/">Spring源码详读</a>
            </div>
            <div>
                
                    转载声明：本博客由<strong>哲锄</strong>创作，采用 <a href="https://creativecommons.org/licenses/by-nc-nd/3.0/" target="_blank"> CC BY 3.0 CN </a> 许可协议。可自由转载、引用，但需署名作者且注明文章出处。如转载至微信公众号，请在文末添加作者公众号二维码。
                
            </div>
            <div>
                
            </div>
        </div>
        <div class="col-sm-2">
            <img src="" width=100%/>
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/2019/07/21/Spring中Bean的ID重复问题解决/" class="pre-post btn btn-default" title='Spring中Bean的ID重复问题解决'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">Spring中Bean的ID重复问题解决</span>
        </a>
    
    
        <a href="/2019/07/14/MessagePack序列化/" class="next-post btn btn-default" title='MessagePack序列化'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">MessagePack序列化</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>






                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-注册组件"><span class="toc-text">1 注册组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-ComponentScan-包扫描-组件标注注解"><span class="toc-text">1.1 @ComponentScan-包扫描+组件标注注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-Bean"><span class="toc-text">1.2 @Bean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-Import"><span class="toc-text">1.3 @Import</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-FactoryBean"><span class="toc-text">1.4 FactoryBean</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Configuration-注册配置"><span class="toc-text">2 @Configuration-注册配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-注册条件"><span class="toc-text">3 注册条件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Conditional"><span class="toc-text">3.1 @Conditional</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-ConditionalOnProperty"><span class="toc-text">3.2 @ConditionalOnProperty</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Lazy-懒注册"><span class="toc-text">4 @Lazy-懒注册</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Bean-的生命周期"><span class="toc-text">5 Bean 的生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-指定初始化和销毁方法"><span class="toc-text">5.1 指定初始化和销毁方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-1-示例：指定-init-method-和-destroy-method"><span class="toc-text">5.1.1 示例：指定 init-method 和 destroy-method</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-2-示例：实现-InitializingBean-和-DisposableBean"><span class="toc-text">5.1.2 示例：实现 InitializingBean 和 DisposableBean</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-3-示例：-PostConstruct-和-PreDestroy"><span class="toc-text">5.1.3 示例：@PostConstruct 和 @PreDestroy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-4-示例：实现-BeanPostProcessor-接口"><span class="toc-text">5.1.4 示例：实现 BeanPostProcessor 接口</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-属性注入"><span class="toc-text">6 属性注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-Value"><span class="toc-text">6.1 @Value</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-BeanPostProcessor-方式"><span class="toc-text">6.2 BeanPostProcessor 方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-Autowired"><span class="toc-text">6.3 @Autowired</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-Aware-接口"><span class="toc-text">7 Aware 接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-Profile"><span class="toc-text">8 @Profile</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-AOP"><span class="toc-text">9 AOP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-原理"><span class="toc-text">9.1 原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-示例"><span class="toc-text">9.2 示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-Transaction"><span class="toc-text">10 Transaction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-Extend"><span class="toc-text">11 Extend</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-1-BeanFactoryPostProcessor"><span class="toc-text">11.1 BeanFactoryPostProcessor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-2-BeanDefinitionRegistryPostProcessor"><span class="toc-text">11.2 BeanDefinitionRegistryPostProcessor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-3-ApplicationListener"><span class="toc-text">11.3 ApplicationListener</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#11-3-1-示例：同步发送邮件"><span class="toc-text">11.3.1 示例：同步发送邮件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-3-2-示例：异步发送邮件"><span class="toc-text">11.3.2 示例：异步发送邮件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-Start-up-process"><span class="toc-text">12 Start-up process</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#12-1-prepareRefresh-刷新前的预处理"><span class="toc-text">12.1 prepareRefresh() 刷新前的预处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-2-obtainFreshBeanFactory-获取-BeanFactory"><span class="toc-text">12.2 obtainFreshBeanFactory() 获取 BeanFactory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-3-prepareBeanFactory-beanFactory-BeanFactory-的预准备工作"><span class="toc-text">12.3 prepareBeanFactory(beanFactory) BeanFactory 的预准备工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-4-postProcessBeanFactory-beanFactory-BeanFactory-准备工作后的后置处理"><span class="toc-text">12.4 postProcessBeanFactory(beanFactory) BeanFactory 准备工作后的后置处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-5-invokeBeanFactoryPostProcessors-beanFactory-执行-BeanFactoryPostProcessor-方法"><span class="toc-text">12.5 invokeBeanFactoryPostProcessors(beanFactory) 执行 BeanFactoryPostProcessor 方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-6-registerBeanPostProcessors-beanFactory-注册-BeanPostProcessor（Bean-的后置处理器）"><span class="toc-text">12.6 registerBeanPostProcessors(beanFactory) 注册 BeanPostProcessor（Bean 的后置处理器）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-7-initMessageSource-初始化-MessageSource-组件（做国际化功能；消息绑定，消息解析）"><span class="toc-text">12.7 initMessageSource() 初始化 MessageSource 组件（做国际化功能；消息绑定，消息解析）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-8-initApplicationEventMulticaster-初始化事件派发器"><span class="toc-text">12.8 initApplicationEventMulticaster() 初始化事件派发器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-9-onRefresh-留给子容器（子类）重写"><span class="toc-text">12.9 onRefresh() 留给子容器（子类）重写</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-10-registerListeners-注册监听器"><span class="toc-text">12.10 registerListeners() 注册监听器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-11-finishBeanFactoryInitialization-beanFactory-初始化所有剩下的单实例-Bean"><span class="toc-text">12.11 finishBeanFactoryInitialization(beanFactory) 初始化所有剩下的单实例 Bean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-12-finishRefresh-完成-BeanFactory-的初始化创建工作"><span class="toc-text">12.12 finishRefresh() 完成 BeanFactory 的初始化创建工作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-核心类"><span class="toc-text">13 核心类</span></a></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
        访问量:
        <strong id="busuanzi_value_site_pv">
            <i class="fa fa-spinner fa-spin"></i>
        </strong>
        &nbsp; | &nbsp;
        访客数:
        <strong id="busuanzi_value_site_uv">
            <i class="fa fa-spinner fa-spin"></i>
        </strong>
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2016
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/itmuch/hexo-theme-itmuch.git" class="copyright-links" target="_blank" rel="nofollow">ITMuch</a>
                </span>
            </div>
        </div>
    </div>
</div>






    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>